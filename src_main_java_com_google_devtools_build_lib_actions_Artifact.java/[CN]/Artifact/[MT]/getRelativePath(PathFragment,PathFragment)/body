{
  if (path.startsWith(ancestorDirectory)) {
    return path.relativeTo(ancestorDirectory);
  }
  int ancestorLength=ancestorDirectory.segmentCount();
  PathFragment builder=PathFragment.EMPTY_FRAGMENT;
  int diffIndex=-1;
  for (int i=0; i < ancestorLength; i++) {
    if (diffIndex == -1 && i < path.segmentCount() && ancestorDirectory.getSegment(i).equals(path.getSegment(i))) {
      continue;
    }
    diffIndex=i;
    builder=builder.getRelative("..");
  }
  int tailIndex=diffIndex == -1 ? ancestorLength : diffIndex;
  for (int i=tailIndex; i < path.segmentCount(); i++) {
    builder=builder.getRelative(path.getSegment(i));
  }
  return builder;
}
