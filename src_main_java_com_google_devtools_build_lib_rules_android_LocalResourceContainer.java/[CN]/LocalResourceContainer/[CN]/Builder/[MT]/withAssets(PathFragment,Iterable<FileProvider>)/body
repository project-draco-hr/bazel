{
  for (  FileProvider target : targets) {
    for (    Artifact file : target.getFilesToBuild()) {
      PathFragment packageFragment=file.getArtifactOwner().getLabel().getPackageIdentifier().getPathFragment();
      PathFragment packageRelativePath=file.getRootRelativePath().relativeTo(packageFragment);
      if (packageRelativePath.startsWith(assetsDir)) {
        PathFragment relativePath=packageRelativePath.relativeTo(assetsDir);
        assetRoots.add(trimTail(file.getExecPath(),relativePath));
      }
 else {
        ruleContext.attributeError(ResourceType.ASSETS.getAttribute(),String.format("'%s' (generated by '%s') is not beneath '%s'",file.getRootRelativePath(),target.getLabel(),assetsDir));
        return this;
      }
      assets.add(file);
    }
  }
  return this;
}
