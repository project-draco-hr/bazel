{
  PathFragment lastResourceDir=null;
  Artifact lastFile=null;
  for (  FileProvider target : targets) {
    for (    Artifact file : target.getFilesToBuild()) {
      PathFragment packageFragment=file.getArtifactOwner().getLabel().getPackageIdentifier().getSourceRoot();
      PathFragment packageRelativePath=file.getRootRelativePath().relativeTo(packageFragment);
      PathFragment resourceDir=findResourceDir(file);
      if (resourceDir == null) {
        ruleContext.attributeError(ResourceType.RESOURCES.getAttribute(),String.format(INCORRECT_RESOURCE_LAYOUT_MESSAGE,file.getRootRelativePath()));
        return this;
      }
      if (lastResourceDir == null || resourceDir.equals(lastResourceDir)) {
        resourceRoots.add(trimTail(file.getExecPath(),makeRelativeTo(resourceDir,packageRelativePath)));
      }
 else {
        ruleContext.attributeError(ResourceType.RESOURCES.getAttribute(),String.format("'%s' (generated by '%s') is not in the same directory '%s' (derived from %s)." + " All resources must share a common directory.",file.getRootRelativePath(),file.getArtifactOwner().getLabel(),lastResourceDir,lastFile.getRootRelativePath()));
        return this;
      }
      resources.add(file);
      lastFile=file;
      lastResourceDir=resourceDir;
    }
  }
  return this;
}
