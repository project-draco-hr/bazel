{
  SkyframeBuildView view=buildViewProvider.getSkyframeBuildView();
  BuildConfiguration configuration=associatedTarget.getConfiguration();
  StoredEventHandler events=new StoredEventHandler();
  CachingAnalysisEnvironment analysisEnvironment=view.createAnalysisEnvironment(key,false,events,env,configuration);
  if (env.valuesMissing()) {
    return null;
  }
  ConfiguredAspectFactory aspectFactory=(ConfiguredAspectFactory)AspectFactory.Util.create(key.getAspect());
  Aspect aspect=view.createAspect(analysisEnvironment,associatedTarget,aspectFactory,directDeps,configConditions,key.getParameters());
  events.replayOn(env.getListener());
  if (events.hasErrors()) {
    analysisEnvironment.disable(associatedTarget.getTarget());
    throw new AspectFunctionException(new AspectCreationException("Analysis of target '" + associatedTarget.getLabel() + "' failed; build aborted"));
  }
  Preconditions.checkState(!analysisEnvironment.hasErrors(),"Analysis environment hasError() but no errors reported");
  if (env.valuesMissing()) {
    return null;
  }
  analysisEnvironment.disable(associatedTarget.getTarget());
  Preconditions.checkNotNull(aspect);
  return new AspectValue(key,associatedTarget.getLabel(),associatedTarget.getTarget().getLocation(),aspect,ImmutableList.copyOf(analysisEnvironment.getRegisteredActions()),transitivePackages.build());
}
