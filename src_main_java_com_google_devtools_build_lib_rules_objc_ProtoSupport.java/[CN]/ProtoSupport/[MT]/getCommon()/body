{
  ObjcCommon.Builder commonBuilder=new ObjcCommon.Builder(ruleContext).setIntermediateArtifacts(intermediateArtifacts).setHasModuleMap().setCompilationArtifacts(getCompilationArtifacts());
  if (targetType == TargetType.LINKING_TARGET) {
    commonBuilder.addDepObjcProviders(attributes.getDepsObjcPrerequisites());
  }
 else   if (targetType == TargetType.PROTO_TARGET) {
    commonBuilder.addDepObjcProviders(attributes.getProtoLibObjcPrerequisites());
    if (usesProtobufLibrary()) {
      commonBuilder.addDirectDependencyHeaderSearchPaths(getUserHeaderSearchPaths());
    }
 else {
      commonBuilder.addUserHeaderSearchPaths(getUserHeaderSearchPaths());
    }
  }
  return commonBuilder.build();
}
