{
  GraphBackedRecursivePackageProvider provider=new GraphBackedRecursivePackageProvider(graph);
  Map<String,ResolvedTargets<Target>> result=Maps.newHashMapWithExpectedSize(patterns.size());
  for (  String pattern : patterns) {
    SkyKey patternKey=TargetPatternValue.key(pattern,TargetPatternEvaluator.DEFAULT_FILTERING_POLICY,parserPrefix);
    TargetPatternValue.TargetPattern targetPattern=((TargetPatternValue.TargetPattern)patternKey.argument());
    TargetParsingException targetParsingException=null;
    if (graph.exists(patternKey)) {
      TargetPatternValue value=(TargetPatternValue)graph.getValue(patternKey);
      if (value != null) {
        ResolvedTargets.Builder<Target> targetsBuilder=ResolvedTargets.builder();
        for (        Label label : value.getTargets().getTargets()) {
          targetsBuilder.add(getExistingTarget(label,provider));
        }
        for (        Label label : value.getTargets().getFilteredTargets()) {
          targetsBuilder.remove(getExistingTarget(label,provider));
        }
        result.put(pattern,targetsBuilder.build());
      }
 else {
        targetParsingException=(TargetParsingException)Preconditions.checkNotNull(graph.getException(patternKey),pattern);
      }
    }
 else {
      TargetPattern.Parser parser=new TargetPattern.Parser(targetPattern.getOffset());
      RecursivePackageProviderBackedTargetPatternResolver resolver=new RecursivePackageProviderBackedTargetPatternResolver(provider,eventHandler,targetPattern.getPolicy(),pkgPath);
      TargetPattern parsedPattern=parser.parse(targetPattern.getPattern());
      try {
        result.put(pattern,parsedPattern.eval(resolver));
      }
 catch (      TargetParsingException e) {
        targetParsingException=e;
      }
catch (      InterruptedException e) {
        throw new QueryException(e.getMessage());
      }
    }
    if (targetParsingException != null) {
      if (!keepGoing) {
        throw targetParsingException;
      }
 else {
        eventHandler.handle(Event.error("Evaluation of query \"" + caller + "\" failed: "+ targetParsingException.getMessage()));
        result.put(pattern,ResolvedTargets.<Target>builder().setError().build());
      }
    }
  }
  return result;
}
