{
  ObjcConfiguration objcConfiguration=ObjcRuleClasses.objcConfiguration(ruleContext);
  ImmutableList.Builder<String> coverageFlags=new ImmutableList.Builder<>();
  ImmutableList.Builder<Artifact> gcnoFiles=new ImmutableList.Builder<>();
  ImmutableList.Builder<Artifact> additionalInputs=new ImmutableList.Builder<>();
  if (isCodeCoverageEnabled && ObjcRuleClasses.isInstrumentable(sourceFile)) {
    coverageFlags.addAll(CLANG_COVERAGE_FLAGS);
    gcnoFiles.add(intermediateArtifacts.gcnoFile(sourceFile));
  }
  CustomCommandLine.Builder commandLine=new CustomCommandLine.Builder().add(CLANG);
  if (ObjcRuleClasses.CPP_SOURCES.matches(sourceFile.getExecPath())) {
    commandLine.add("-stdlib=libc++");
  }
  if (compilationArtifacts.hasSwiftSources()) {
    commandLine.add("-I");
    commandLine.addPath(intermediateArtifacts.swiftHeader().getExecPath().getParentDirectory());
    additionalInputs.add(intermediateArtifacts.swiftHeader());
  }
  if (objcConfiguration.shouldStripBinary()) {
    commandLine.add("-g");
  }
  Artifact dotdFile=intermediateArtifacts.dotdFile(sourceFile);
  commandLine.add(IosSdkCommands.compileFlagsForClang(objcConfiguration)).add(IosSdkCommands.commonLinkAndCompileFlagsForClang(objcProvider,objcConfiguration)).add(objcConfiguration.getCoptsForCompilationMode()).addBeforeEachPath("-iquote",ObjcCommon.userHeaderSearchPaths(ruleContext.getConfiguration())).addBeforeEachExecPath("-include",compilationArtifacts.getPchFile().asSet()).addBeforeEachPath("-I",objcProvider.get(INCLUDE)).addBeforeEachPath("-isystem",objcProvider.get(INCLUDE_SYSTEM)).add(otherFlags).addFormatEach("-D%s",objcProvider.get(DEFINE)).add(coverageFlags.build()).add(objcConfiguration.getCopts()).add(attributes.copts()).add(attributes.optionsCopts());
  PathFragment sourceExecPathFragment=sourceFile.getExecPath();
  String sourcePath=sourceExecPathFragment.getPathString();
  if (!sourceExecPathFragment.isAbsolute() && objcConfiguration.getUseAbsolutePathsForActions()) {
    sourcePath=objcConfiguration.getXcodeWorkspaceRoot() + "/" + sourcePath;
  }
  commandLine.add("-c").add(sourcePath).addExecPath("-o",objFile).add("-MD").addExecPath("-MF",dotdFile);
  if (moduleMap.isPresent()) {
    commandLine.add(attributes.enableModules() ? "-fmodules" : "-fmodule-maps").add("-iquote").add(moduleMap.get().getArtifact().getExecPath().getParentDirectory().toString()).add("-fmodule-name=" + moduleMap.get().getName());
    if (attributes.enableModules()) {
      String cachePath=ruleContext.getConfiguration().getGenfilesFragment() + "/_objc_module_cache";
      commandLine.add("-fmodules-cache-path=" + cachePath);
    }
  }
  ruleContext.registerAction(ObjcRuleClasses.spawnOnDarwinActionBuilder(ruleContext).setMnemonic("ObjcCompile").setExecutable(xcrunwrapper(ruleContext)).setCommandLine(commandLine.build()).addInput(sourceFile).addInputs(additionalInputs.build()).addOutput(objFile).addOutputs(gcnoFiles.build()).addOutput(dotdFile).addTransitiveInputs(objcProvider.get(HEADER)).addTransitiveInputs(objcProvider.get(MODULE_MAP)).addInputs(compilationArtifacts.getPrivateHdrs()).addTransitiveInputs(objcProvider.get(FRAMEWORK_FILE)).addInputs(compilationArtifacts.getPchFile().asSet()).build(ruleContext));
}
