{
  NewRepositoryBuildFileHandler buildFileHandler=new NewRepositoryBuildFileHandler(directories.getWorkspace());
  if (!buildFileHandler.prepareBuildFile(rule,env)) {
    return null;
  }
  PathFragment pathFragment=getTargetPath(rule,directories.getWorkspace());
  if (!symlinkLocalRepositoryContents(outputDirectory,directories.getOutputBase().getFileSystem().getPath(pathFragment))) {
    return null;
  }
  buildFileHandler.finishBuildFile(outputDirectory);
  Path workspaceFile=outputDirectory.getRelative("WORKSPACE");
  if (workspaceFile.exists()) {
    try {
      workspaceFile.delete();
    }
 catch (    IOException e) {
      throw new RepositoryFunctionException(e,SkyFunctionException.Transience.TRANSIENT);
    }
  }
  createWorkspaceFile(outputDirectory,rule);
  return RepositoryDirectoryValue.create(outputDirectory);
}
