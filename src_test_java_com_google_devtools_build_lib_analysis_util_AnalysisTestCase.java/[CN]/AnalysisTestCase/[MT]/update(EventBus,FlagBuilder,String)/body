{
  Set<Flag> flags=config.flags;
  LoadingPhaseRunner.Options loadingOptions=Options.getDefaults(LoadingPhaseRunner.Options.class);
  loadingOptions.loadingPhaseThreads=LOADING_PHASE_THREADS;
  BuildView.Options viewOptions=optionsParser.getOptions(BuildView.Options.class);
  viewOptions.keepGoing=flags.contains(Flag.KEEP_GOING);
  viewOptions.analysisWarningsAsErrors=flags.contains(Flag.ANALYSIS_WARNINGS_AS_ERRORS);
  BuildOptions buildOptions=ruleClassProvider.createBuildOptions(optionsParser);
  PackageCacheOptions packageCacheOptions=optionsParser.getOptions(PackageCacheOptions.class);
  PathPackageLocator pathPackageLocator=PathPackageLocator.create(packageCacheOptions.packagePath,reporter,rootDirectory,rootDirectory);
  skyframeExecutor.preparePackageLoading(pathPackageLocator,packageCacheOptions.defaultVisibility,true,ruleClassProvider.getDefaultsPackageContent(),UUID.randomUUID());
  skyframeExecutor.invalidateFilesUnderPathForTesting(ModifiedFileSet.EVERYTHING_MODIFIED,rootDirectory);
  LoadingResult loadingResult=loadingPhaseRunner.execute(reporter,eventBus,ImmutableList.copyOf(labels),loadingOptions,buildOptions.getAllLabels(),viewOptions.keepGoing,false,null);
  BuildRequestOptions requestOptions=optionsParser.getOptions(BuildRequestOptions.class);
  ImmutableSortedSet<String> multiCpu=ImmutableSortedSet.copyOf(requestOptions.multiCpus);
  BuildConfigurationKey configurationKey=new BuildConfigurationKey(buildOptions,directories,ImmutableMap.<String,String>of(),multiCpu);
  masterConfig=skyframeExecutor.createConfigurations(configurationFactory,configurationKey);
  analysisResult=buildView.update(loadingResult,masterConfig,viewOptions,AnalysisTestUtil.TOP_LEVEL_ARTIFACT_CONTEXT,reporter,eventBus);
}
