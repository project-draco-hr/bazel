{
  FilteringPolicy actualPolicy=rulesOnly ? FilteringPolicies.and(FilteringPolicies.RULES_ONLY,policy) : policy;
  PathFragment directory=new PathFragment(pathPrefix);
  if (directory.containsUplevelReferences()) {
    throw new TargetParsingException("up-level references are not permitted: '" + directory.getPathString() + "'");
  }
  if (!pathPrefix.isEmpty() && (LabelValidator.validatePackageName(pathPrefix) != null)) {
    throw new TargetParsingException("'" + pathPrefix + "' is not a valid package name");
  }
  ResolvedTargets.Builder<Target> builder=ResolvedTargets.builder();
  for (  Path root : pkgPath.getPathEntries()) {
    RootedPath rootedPath=RootedPath.toRootedPath(root,directory);
    Iterable<PathFragment> packagesUnderDirectory=recursivePackageProvider.getPackagesUnderDirectory(rootedPath);
    for (    PathFragment pkg : packagesUnderDirectory) {
      builder.merge(getTargetsInPackage(originalPattern,pkg,FilteringPolicies.NO_FILTER));
    }
  }
  if (builder.isEmpty()) {
    throw new TargetParsingException("no targets found beneath '" + directory + "'");
  }
  ResolvedTargets<Target> intermediateResult=builder.build();
  ResolvedTargets.Builder<Target> filteredBuilder=ResolvedTargets.builder();
  if (intermediateResult.hasError()) {
    filteredBuilder.setError();
  }
  for (  Target target : intermediateResult.getTargets()) {
    if (actualPolicy.shouldRetain(target,false)) {
      filteredBuilder.add(target);
    }
  }
  return filteredBuilder.build();
}
