{
  Set<Label> labelsToLoad=ImmutableSet.copyOf(labelsToLoadUnconditionally.values());
  boolean loadingSuccessful=pkgLoader.sync(eventHandler,targetsToLoad,labelsToLoad,keepGoing,loadingPhaseThreads,Integer.MAX_VALUE);
  Set<Package> errorFreePackages=pkgLoader.getErrorFreeVisitedPackages(eventHandler);
  ImmutableSet<Target> targetsToAnalyze;
  if (loadingSuccessful) {
    targetsToAnalyze=targetsToLoad;
  }
 else   if (keepGoing) {
    targetsToAnalyze=filterErrorFreeTargets(eventHandler,eventBus,pkgLoader,targetsToLoad,labelsToLoadUnconditionally);
    reportAboutPartiallySuccesfulLoading(targetsToLoad,targetsToAnalyze,eventHandler);
  }
 else {
    throw new LoadingFailedException("Loading failed; build aborted");
  }
  return new BaseLoadingResult(targetsToAnalyze,loadingSuccessful,LoadingPhaseRunner.collectPackageRoots(errorFreePackages));
}
