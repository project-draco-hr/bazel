{
  Build.Rule.Builder builder=Build.Rule.newBuilder();
  builder.setName(rule.getLabel().getName());
  builder.setRuleClass(rule.getRuleClass());
  builder.setPublicByDefault(rule.getRuleClassObject().isPublicByDefault());
  RawAttributeMapper rawAttributeMapper=RawAttributeMapper.of(rule);
  for (  Attribute attr : rule.getAttributes()) {
    Object rawAttributeValue=rawAttributeMapper.getRawAttributeValue(rule,attr);
    Object valueToSerialize;
    if (rawAttributeValue instanceof ComputedDefault) {
      if (rule.getRuleClassObject().isSkylark()) {
        Preconditions.checkState(SKYLARK_RULE_CLASS_COMPUTED_DEFAULT_ATTRIBUTES.contains(attr.getName()),"Unexpected ComputedDefault value for %s in %s",attr,rule);
        valueToSerialize=rawAttributeMapper.get(attr.getName(),attr.getType());
      }
 else {
        Iterable<Object> possibleValues=AggregatingAttributeMapper.of(rule).getPossibleAttributeValues(rule,attr);
        valueToSerialize=AggregatingAttributeMapper.flattenAttributeValues(attr.getType(),possibleValues);
      }
    }
 else {
      valueToSerialize=rawAttributeValue;
    }
    builder.addAttribute(AttributeSerializer.getAttributeProto(attr,valueToSerialize,rule.isAttributeValueExplicitlySpecified(attr),true,false));
  }
  return builder;
}
