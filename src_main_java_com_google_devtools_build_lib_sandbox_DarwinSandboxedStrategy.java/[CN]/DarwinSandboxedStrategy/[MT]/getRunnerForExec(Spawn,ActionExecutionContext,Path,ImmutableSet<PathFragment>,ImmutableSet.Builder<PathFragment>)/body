{
  ImmutableMap<PathFragment,Path> linkPaths;
  try {
    linkPaths=getMounts(spawn,actionExecutionContext);
  }
 catch (  IllegalArgumentException|IOException e) {
    throw new EnvironmentalExecException("Could not prepare mounts for sandbox execution",e);
  }
  for (  PathFragment optionalOutput : spawn.getOptionalOutputFiles()) {
    Preconditions.checkArgument(!optionalOutput.isAbsolute());
    outputFiles.add(optionalOutput);
  }
  for (  ActionInput output : spawn.getOutputFiles()) {
    outputFiles.add(new PathFragment(output.getExecPathString()));
  }
  DarwinSandboxRunner runner;
  try {
    Path sandboxConfigPath=generateScriptFile(sandboxPath,unblockNetwork || spawn.getExecutionInfo().containsKey("requires-network"));
    runner=new DarwinSandboxRunner(execRoot,sandboxPath,sandboxPath.getRelative("execroot"),sandboxConfigPath,linkPaths,createDirs,verboseFailures,sandboxOptions.sandboxDebug);
  }
 catch (  IOException e) {
    throw new UserExecException("I/O error during sandboxed execution",e);
  }
  return runner;
}
