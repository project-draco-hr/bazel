{
  Metadata metadata=perActionHandler.getMetadata(artifact);
  if (metadata != null) {
    return metadata;
  }
  Preconditions.checkState(artifact.isSourceArtifact(),artifact);
  metadata=undeclaredInputsMetadata.get(artifact);
  if (metadata != null) {
    return metadata;
  }
  FileStatus stat=artifact.getPath().stat();
  if (DigestUtils.useFileDigest(artifact,stat.isFile(),stat.getSize())) {
    metadata=new Metadata(Preconditions.checkNotNull(DigestUtils.getDigestOrFail(artifact.getPath(),stat.getSize()),artifact));
  }
 else {
    metadata=new Metadata(stat.getLastModifiedTime());
  }
  Metadata oldMetadata=undeclaredInputsMetadata.put(artifact,metadata);
  FileAndMetadataCache.checkInconsistentData(artifact,oldMetadata,metadata);
  return metadata;
}
