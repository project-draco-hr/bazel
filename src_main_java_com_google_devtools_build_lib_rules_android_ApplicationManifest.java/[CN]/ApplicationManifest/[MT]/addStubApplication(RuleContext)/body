{
  Artifact stubManifest=ruleContext.getImplicitOutputArtifact(AndroidRuleClasses.STUB_APPLICATON_MANIFEST);
  SpawnAction.Builder builder=new SpawnAction.Builder().setExecutable(ruleContext.getExecutablePrerequisite("$stubify_manifest",Mode.HOST)).setProgressMessage("Injecting stub application").setMnemonic("InjectStubApplication").addArgument("--input_manifest").addInputArgument(manifest).addArgument("--output_manifest").addOutputArgument(stubManifest).addArgument("--output_datafile").addOutputArgument(ruleContext.getImplicitOutputArtifact(AndroidRuleClasses.STUB_APPLICATION_DATA));
  String overridePackage=getOverridePackage(ruleContext);
  if (overridePackage != null) {
    builder.addArgument("--override_package");
    builder.addArgument(overridePackage);
  }
  ruleContext.registerAction(builder.build(ruleContext));
  return new ApplicationManifest(stubManifest);
}
