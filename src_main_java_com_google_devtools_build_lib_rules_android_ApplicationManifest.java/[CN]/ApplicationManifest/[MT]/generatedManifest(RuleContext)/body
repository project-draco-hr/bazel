{
  Artifact generatedManifest=ruleContext.getAnalysisEnvironment().getDerivedArtifact(ruleContext.getUniqueDirectory(ruleContext.getRule().getName() + "_generated").getChild("AndroidManifest.xml"),ruleContext.getBinOrGenfilesDirectory());
  String manifestPackage;
  if (ruleContext.attributes().isAttributeValueExplicitlySpecified("custom_package")) {
    manifestPackage=ruleContext.attributes().get("custom_package",Type.STRING);
  }
 else {
    manifestPackage=JavaUtil.getJavaFullClassname(ruleContext.getRule().getPackage().getNameFragment());
  }
  String contents=Joiner.on("\n").join("<?xml version=\"1.0\" encoding=\"utf-8\"?>","<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"","          package=\"" + manifestPackage + "\">","   <application>","   </application>","</manifest>");
  ruleContext.getAnalysisEnvironment().registerAction(new FileWriteAction(ruleContext.getActionOwner(),generatedManifest,contents,false));
  return new ApplicationManifest(generatedManifest);
}
