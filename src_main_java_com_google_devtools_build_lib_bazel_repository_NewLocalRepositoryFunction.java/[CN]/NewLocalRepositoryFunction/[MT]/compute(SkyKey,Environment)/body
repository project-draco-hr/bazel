{
  RepositoryName repositoryName=(RepositoryName)skyKey.argument();
  Rule rule=RepositoryFunction.getRule(repositoryName,NewLocalRepositoryRule.NAME,env);
  if (rule == null) {
    return null;
  }
  Path repositoryDirectory=getExternalRepositoryDirectory().getRelative(rule.getName());
  Path outputDirectory=repositoryDirectory.getRelative(rule.getName());
  try {
    FileSystemUtils.createDirectoryAndParents(outputDirectory);
  }
 catch (  IOException e) {
    throw new RepositoryFunctionException(e,Transience.TRANSIENT);
  }
  FileValue directoryValue=getRepositoryDirectory(outputDirectory,env);
  if (directoryValue == null) {
    return null;
  }
  try {
    Path workspaceFile=repositoryDirectory.getRelative("WORKSPACE");
    FileSystemUtils.writeContent(workspaceFile,Charset.forName("UTF-8"),"# DO NOT EDIT: automatically generated WORKSPACE file for " + rule + "\n");
  }
 catch (  IOException e) {
    throw new RepositoryFunctionException(e,Transience.TRANSIENT);
  }
  AggregatingAttributeMapper mapper=AggregatingAttributeMapper.of(rule);
  String path=mapper.get("path",Type.STRING);
  PathFragment pathFragment=new PathFragment(path);
  if (!pathFragment.isAbsolute()) {
    throw new RepositoryFunctionException(new EvalException(rule.getLocation(),"In " + rule + " the 'path' attribute must specify an absolute path"),Transience.PERSISTENT);
  }
  Path pathTarget=getOutputBase().getFileSystem().getPath(pathFragment);
  Path symlinkPath=outputDirectory.getRelative(pathTarget.getBaseName());
  if (createSymbolicLink(symlinkPath,pathTarget,env) == null) {
    return null;
  }
  PathFragment buildFile=new PathFragment(mapper.get("build_file",Type.STRING));
  Path buildFileTarget=getWorkspace().getRelative(buildFile);
  if (buildFile.equals(PathFragment.EMPTY_FRAGMENT) || buildFile.isAbsolute() || !buildFileTarget.exists()) {
    throw new RepositoryFunctionException(new EvalException(rule.getLocation(),"In " + rule + " the 'build_file' attribute must specify a relative path to an existing file"),Transience.PERSISTENT);
  }
  Path buildFilePath=outputDirectory.getRelative("BUILD");
  if (createSymbolicLink(buildFilePath,buildFileTarget,env) == null) {
    return null;
  }
  return new RepositoryValue(repositoryDirectory,directoryValue);
}
