{
  if (!data.exists()) {
    throw new FileNotFoundException(file.prettyPrint() + " does not exist");
  }
  if (file instanceof Artifact) {
    boolean isFile=data.isFile();
    boolean useDigest=DigestUtils.useFileDigest(isFile,isFile ? data.getSize() : 0);
    if (useDigest && data.getDigest() != null) {
      return new Metadata(data.getDigest());
    }
    injectedDigest=injectedDigest != null || !isFile ? injectedDigest : data.getDigest();
    FileArtifactValue value=FileArtifactValue.create((Artifact)file,isFile,isFile ? data.getSize() : 0,injectedDigest);
    FileArtifactValue oldValue=additionalOutputData.putIfAbsent((Artifact)file,value);
    checkInconsistentData(file,oldValue,value);
    return metadataFromValue(value);
  }
 else {
    FileArtifactValue value=FileArtifactValue.createWithDigest(file.getPath(),injectedDigest,data.getSize());
    FileArtifactValue oldValue=cachedTreeArtifactFileData.putIfAbsent(file,value);
    checkInconsistentData(file,oldValue,value);
    return new Metadata(value.getDigest());
  }
}
