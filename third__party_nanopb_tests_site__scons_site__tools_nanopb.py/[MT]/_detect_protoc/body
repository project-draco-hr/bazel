def _detect_protoc(env):
    'Find the path to the protoc compiler.'
    if env.has_key('PROTOC'):
        return env['PROTOC']
    n = _detect_nanopb(env)
    p1 = os.path.join(n, 'generator-bin', ('protoc' + env['PROGSUFFIX']))
    if os.path.exists(p1):
        return env['ESCAPE'](p1)
    p = env.WhereIs('protoc')
    if p:
        return env['ESCAPE'](p)
    raise SCons.Errors.StopError(NanopbWarning, 'Could not find the protoc compiler')
