def generate(env):
    'Add Builder for nanopb protos.'
    env['NANOPB'] = _detect_nanopb(env)
    env['PROTOC'] = _detect_protoc(env)
    env['PROTOCFLAGS'] = _detect_protocflags(env)
    env.SetDefault(PROTOCPATH=['.', os.path.join(env['NANOPB'], 'generator', 'proto')])
    env.SetDefault(NANOPB_PROTO_CMD='$PROTOC $PROTOC_OPTS --nanopb_out=. $SOURCE')
    env['BUILDERS']['NanopbProto'] = _nanopb_proto_builder
