def _detect_nanopb(env):
    'Find the path to nanopb root directory.'
    if env.has_key('NANOPB'):
        return env['NANOPB']
    p = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..', '..'))
    if (os.path.isdir(p) and os.path.isfile(os.path.join(p, 'pb.h'))):
        return p
    raise SCons.Errors.StopError(NanopbWarning, 'Could not find the nanopb root directory')
