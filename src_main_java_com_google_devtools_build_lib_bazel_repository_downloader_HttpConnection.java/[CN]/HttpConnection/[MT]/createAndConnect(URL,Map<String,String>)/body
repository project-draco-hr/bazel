{
  Proxy proxy=ProxyHelper.createProxyIfNeeded(url.toString(),clientEnv);
  URLConnection connection=url.openConnection(proxy);
  if (connection instanceof HttpURLConnection) {
    return createAndConnectViaHttp(proxy,url,(HttpURLConnection)connection);
  }
  int contentLength=connection.getContentLength();
  if (contentLength == 0) {
    throw new IOException("Attempted to download an empty file");
  }
  return new HttpConnection(connection.getInputStream(),contentLength);
}
