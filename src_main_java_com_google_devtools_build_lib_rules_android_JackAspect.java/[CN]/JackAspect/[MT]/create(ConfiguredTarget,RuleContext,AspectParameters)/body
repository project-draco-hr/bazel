{
  JavaSourceInfoProvider sourceProvider=base.getProvider(JavaSourceInfoProvider.class);
  PathFragment rulePath=ruleContext.getLabel().toPathFragment();
  PathFragment jackLibraryPath=rulePath.replaceName("lib" + rulePath.getBaseName() + ".jack");
  Artifact jackLibraryOutput=ruleContext.getAnalysisEnvironment().getDerivedArtifact(jackLibraryPath,ruleContext.getBinOrGenfilesDirectory());
  AndroidSdkProvider androidSdk=AndroidSdkProvider.fromRuleContext(ruleContext);
  JackCompilationHelper jackHelper=new JackCompilationHelper.Builder().setRuleContext(ruleContext).setOutputArtifact(jackLibraryOutput).setAndroidSdk(androidSdk).addJavaSources(sourceProvider.getSourceFiles()).addSourceJars(sourceProvider.getSourceJars()).addCompiledJars(sourceProvider.getJarFiles()).addResources(sourceProvider.getResources()).addProcessorNames(sourceProvider.getProcessorNames()).addProcessorClasspathJars(sourceProvider.getProcessorPath()).addExports(getPotentialDependency(ruleContext,"exports")).addDeps(getPotentialDependency(ruleContext,"deps")).addRuntimeDeps(getPotentialDependency(ruleContext,"runtime_deps")).build();
  JackLibraryProvider result=JavaCommon.isNeverLink(ruleContext) ? jackHelper.compileAsNeverlinkLibrary() : jackHelper.compileAsLibrary();
  return new ConfiguredAspect.Builder(NAME,ruleContext).addProvider(JackLibraryProvider.class,result).build();
}
