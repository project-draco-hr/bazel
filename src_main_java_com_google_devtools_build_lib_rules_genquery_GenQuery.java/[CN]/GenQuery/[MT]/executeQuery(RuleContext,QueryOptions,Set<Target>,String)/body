{
  SkyFunction.Environment env=ruleContext.getAnalysisEnvironment().getSkyframeEnv();
  Pair<ImmutableMap<PackageIdentifier,Package>,Set<Label>> closureInfo=constructPackageMap(env,scope);
  ImmutableMap<PackageIdentifier,Package> packageMap=closureInfo.first;
  Set<Label> validTargets=closureInfo.second;
  PackageProvider packageProvider=new PreloadedMapPackageProvider(packageMap,validTargets);
  TargetPatternEvaluator evaluator=new SkyframeEnvTargetPatternEvaluator(env);
  Predicate<Label> labelFilter=Predicates.in(validTargets);
  return doQuery(queryOptions,packageProvider,labelFilter,evaluator,query,ruleContext);
}
