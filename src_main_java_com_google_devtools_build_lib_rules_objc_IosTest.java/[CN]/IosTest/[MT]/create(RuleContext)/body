{
  ObjcCommon common=common(ruleContext);
  if (!common.getCompilationArtifacts().get().getArchive().isPresent()) {
    ruleContext.ruleError(REQUIRES_SOURCE_ERROR);
  }
  if (!ruleContext.getFragment(AppleConfiguration.class).getIosMultiCpus().isEmpty()) {
    ruleContext.ruleError(NO_MULTI_CPUS_ERROR);
  }
  XcodeProvider.Builder xcodeProviderBuilder=new XcodeProvider.Builder();
  NestedSetBuilder<Artifact> filesToBuild=NestedSetBuilder.stableOrder();
  addResourceFilesToBuild(ruleContext,common.getObjcProvider(),filesToBuild);
  XcodeProductType productType=getProductType(ruleContext);
  String bundleFormat;
  if (!isXcTest(ruleContext)) {
    bundleFormat=ReleaseBundlingSupport.APP_BUNDLE_DIR_FORMAT;
    new CompilationSupport(ruleContext).registerLinkActions(common.getObjcProvider(),new ExtraLinkArgs(),ImmutableList.<Artifact>of()).registerCompileAndArchiveActions(common).addXcodeSettings(xcodeProviderBuilder,common).validateAttributes();
  }
 else {
    XcodeProvider appIpaXcodeProvider=ruleContext.getPrerequisite(XCTEST_APP,Mode.TARGET,XcodeProvider.class);
    xcodeProviderBuilder.setTestHost(appIpaXcodeProvider).setProductType(productType);
    XcTestAppProvider testApp=xcTestAppProvider(ruleContext);
    Artifact bundleLoader=testApp.getBundleLoader();
    LibrariesToLink librariesToLink=LibrariesToLink.xcTestLibraries(ruleContext,common.getObjcProvider());
    ExtraLinkArgs extraLinkArgs=new ExtraLinkArgs("-bundle","-bundle_loader",bundleLoader.getExecPathString());
    bundleFormat=ReleaseBundlingSupport.XCTEST_BUNDLE_DIR_FORMAT;
    filesToBuild.add(testApp.getIpa());
    new CompilationSupport(ruleContext).registerLinkActionsForXcTest(common.getObjcProvider(),extraLinkArgs,ImmutableList.of(bundleLoader),librariesToLink).registerCompileAndArchiveActions(common).addXcodeSettings(xcodeProviderBuilder,common).validateAttributes();
  }
  ObjcConfiguration objcConfiguration=ObjcRuleClasses.objcConfiguration(ruleContext);
  new ReleaseBundlingSupport(ruleContext,common.getObjcProvider(),LinkedBinary.LOCAL_AND_DEPENDENCIES,bundleFormat,objcConfiguration.getMinimumOs()).registerActions().addXcodeSettings(xcodeProviderBuilder).addFilesToBuild(filesToBuild).validateResources().validateAttributes();
  new ResourceSupport(ruleContext).validateAttributes().addXcodeSettings(xcodeProviderBuilder);
  new XcodeSupport(ruleContext).addXcodeSettings(xcodeProviderBuilder,common.getObjcProvider(),productType).addDependencies(xcodeProviderBuilder,new Attribute("bundles",Mode.TARGET)).addDependencies(xcodeProviderBuilder,new Attribute("deps",Mode.TARGET)).addNonPropagatedDependencies(xcodeProviderBuilder,new Attribute("non_propagated_deps",Mode.TARGET)).addFilesToBuild(filesToBuild).registerActions(xcodeProviderBuilder.build());
  XcodeProvider xcodeProvider=xcodeProviderBuilder.build();
  NestedSet<Artifact> filesToBuildSet=filesToBuild.build();
  Runfiles.Builder runfilesBuilder=new Runfiles.Builder(ruleContext.getWorkspaceName()).addRunfiles(ruleContext,RunfilesProvider.DEFAULT_RUNFILES);
  NestedSetBuilder<Artifact> filesToBuildBuilder=NestedSetBuilder.<Artifact>stableOrder().addTransitive(filesToBuildSet);
  TestSupport testSupport=new TestSupport(ruleContext).registerTestRunnerActions().addRunfiles(runfilesBuilder).addFilesToBuild(filesToBuildBuilder);
  Artifact executable=testSupport.generatedTestScript();
  Runfiles runfiles=runfilesBuilder.build();
  RunfilesSupport runfilesSupport=RunfilesSupport.withExecutable(ruleContext,runfiles,executable);
  return new RuleConfiguredTargetBuilder(ruleContext).setFilesToBuild(filesToBuildBuilder.build()).add(XcodeProvider.class,xcodeProvider).add(RunfilesProvider.class,RunfilesProvider.simple(runfiles)).add(ExecutionInfoProvider.class,new ExecutionInfoProvider(ImmutableMap.of(ExecutionRequirements.REQUIRES_DARWIN,""))).addProvider(InstrumentedFilesProvider.class,new CompilationSupport(ruleContext).getInstrumentedFilesProvider(common)).addProviders(testSupport.getExtraProviders()).setRunfilesSupport(runfilesSupport,executable).build();
}
