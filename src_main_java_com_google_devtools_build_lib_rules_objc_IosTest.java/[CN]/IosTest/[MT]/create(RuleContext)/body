{
  ObjcCommon common=common(ruleContext);
  OptionsProvider optionsProvider=optionsProvider(ruleContext);
  if (!common.getCompilationArtifacts().get().getArchive().isPresent()) {
    ruleContext.ruleError(REQUIRES_SOURCE_ERROR);
  }
  if (!ObjcRuleClasses.objcConfiguration(ruleContext).getIosMultiCpus().isEmpty()) {
    ruleContext.ruleError(NO_MULTI_CPUS_ERROR);
  }
  XcodeProvider.Builder xcodeProviderBuilder=new XcodeProvider.Builder();
  NestedSetBuilder<Artifact> filesToBuild=NestedSetBuilder.stableOrder();
  addResourceFilesToBuild(ruleContext,common.getObjcProvider(),filesToBuild);
  XcodeProductType productType;
  ExtraLinkArgs extraLinkArgs;
  ExtraLinkInputs extraLinkInputs;
  if (!isXcTest(ruleContext)) {
    productType=XcodeProductType.APPLICATION;
    extraLinkArgs=new ExtraLinkArgs();
    extraLinkInputs=new ExtraLinkInputs();
  }
 else {
    productType=XcodeProductType.UNIT_TEST;
    XcodeProvider appIpaXcodeProvider=ruleContext.getPrerequisite(XCTEST_APP,Mode.TARGET,XcodeProvider.class);
    xcodeProviderBuilder.setTestHost(appIpaXcodeProvider).setProductType(productType);
    XcTestAppProvider testApp=xcTestAppProvider(ruleContext);
    Artifact bundleLoader=testApp.getBundleLoader();
    extraLinkArgs=new ExtraLinkArgs("-bundle","-bundle_loader",bundleLoader.getExecPathString());
    extraLinkInputs=new ExtraLinkInputs(bundleLoader);
    filesToBuild.add(testApp.getIpa());
  }
  if (ruleContext.getConfiguration().isCodeCoverageEnabled()) {
    extraLinkArgs=extraLinkArgs.appendedWith(CompilationSupport.LINKER_COVERAGE_FLAGS);
  }
  new CompilationSupport(ruleContext).registerLinkActions(common.getObjcProvider(),extraLinkArgs,extraLinkInputs).registerJ2ObjcCompileAndArchiveActions(optionsProvider,common.getObjcProvider()).registerCompileAndArchiveActions(common,optionsProvider).addXcodeSettings(xcodeProviderBuilder,common,optionsProvider).validateAttributes();
  ReleaseBundlingSupport releaseBundlingSupport=new ReleaseBundlingSupport(ruleContext,common.getObjcProvider(),optionsProvider,LinkedBinary.LOCAL_AND_DEPENDENCIES,ReleaseBundlingSupport.APP_BUNDLE_DIR_FORMAT);
  releaseBundlingSupport.registerActions().addXcodeSettings(xcodeProviderBuilder).addFilesToBuild(filesToBuild).validateResources().validateAttributes();
  new ResourceSupport(ruleContext).validateAttributes().addXcodeSettings(xcodeProviderBuilder);
  new XcodeSupport(ruleContext).addXcodeSettings(xcodeProviderBuilder,common.getObjcProvider(),productType).addDependencies(xcodeProviderBuilder,new Attribute("bundles",Mode.TARGET)).addDependencies(xcodeProviderBuilder,new Attribute("deps",Mode.TARGET)).addDependencies(xcodeProviderBuilder,new Attribute("non_propagated_deps",Mode.TARGET)).addFilesToBuild(filesToBuild).registerActions(xcodeProviderBuilder.build());
  return create(ruleContext,common,xcodeProviderBuilder.build(),filesToBuild.build());
}
