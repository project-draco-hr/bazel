{
  Path runfilesDir=null;
  try {
    runfilesDir=TestStrategy.getLocalRunfilesDirectory(action,actionExecutionContext,binTools);
  }
 catch (  ExecException e) {
    throw new TestExecException(e.getMessage());
  }
  Path testTmpDir=TestStrategy.getTmpRoot(workspace,actionExecutionContext.getExecutor().getExecRoot(),executionOptions).getChild(getTmpDirName(action.getExecutionSettings().getExecutable().getExecPath()));
  Path workingDirectory=runfilesDir.getRelative(action.getRunfilesPrefix());
  TestRunnerAction.ResolvedPaths resolvedPaths=action.resolve(actionExecutionContext.getExecutor().getExecRoot());
  Map<String,String> env=getEnv(action,runfilesDir,testTmpDir,resolvedPaths);
  Map<String,String> info=new HashMap<>();
  info.put("timeout","" + getTimeout(action));
  info.putAll(action.getTestProperties().getExecutionInfo());
  Spawn spawn=new BaseSpawn(getArgs(TEST_SETUP,"",action),env,info,new RunfilesSupplierImpl(runfilesDir.asFragment(),action.getExecutionSettings().getRunfiles()),action,action.getTestProperties().getLocalResourceUsage(executionOptions.usingLocalTestJobs()));
  Executor executor=actionExecutionContext.getExecutor();
  try {
    FileSystemUtils.createDirectoryAndParents(testTmpDir);
  }
 catch (  IOException e) {
    executor.getEventHandler().handle(Event.error("Could not create TEST_TMPDIR: " + e));
    throw new EnvironmentalExecException("Could not create TEST_TMPDIR " + testTmpDir,e);
  }
  ResourceSet resources=null;
  FileOutErr fileOutErr=null;
  try {
    FileSystemUtils.createDirectoryAndParents(workingDirectory);
    fileOutErr=new FileOutErr(action.getTestLog().getPath(),action.resolve(actionExecutionContext.getExecutor().getExecRoot()).getTestStderr());
    resources=action.getTestProperties().getLocalResourceUsage(executionOptions.usingLocalTestJobs());
    ResourceManager.instance().acquireResources(action,resources);
    TestResultData data=execute(actionExecutionContext.withFileOutErr(fileOutErr),spawn,action);
    appendStderr(fileOutErr.getOutputFile(),fileOutErr.getErrorFile());
    finalizeTest(actionExecutionContext,action,data);
  }
 catch (  IOException e) {
    executor.getEventHandler().handle(Event.error("Caught I/O exception: " + e));
    throw new EnvironmentalExecException("unexpected I/O exception",e);
  }
 finally {
    if (resources != null) {
      ResourceManager.instance().releaseResources(action,resources);
    }
    try {
      if (fileOutErr != null) {
        fileOutErr.close();
      }
    }
 catch (    IOException e) {
    }
  }
}
