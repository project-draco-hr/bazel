{
  Path runfilesDir=null;
  try {
    runfilesDir=TestStrategy.getLocalRunfilesDirectory(action,actionExecutionContext,binTools);
  }
 catch (  ExecException e) {
    throw new TestExecException(e.getMessage());
  }
  Path workingDirectory=runfilesDir.getRelative(action.getRunfilesPrefix());
  Map<String,String> env=getEnv(action,runfilesDir);
  Spawn spawn=new BaseSpawn(getArgs(action),env,action.getTestProperties().getExecutionInfo(),action,action.getTestProperties().getLocalResourceUsage(executionOptions.usingLocalTestJobs()));
  Executor executor=actionExecutionContext.getExecutor();
  ResourceSet resources=null;
  FileOutErr fileOutErr=null;
  try {
    FileSystemUtils.createDirectoryAndParents(workingDirectory);
    fileOutErr=new FileOutErr(action.getTestLog().getPath(),action.resolve(actionExecutionContext.getExecutor().getExecRoot()).getTestStderr());
    resources=action.getTestProperties().getLocalResourceUsage(executionOptions.usingLocalTestJobs());
    ResourceManager.instance().acquireResources(action,resources);
    TestResultData data=execute(actionExecutionContext.withFileOutErr(fileOutErr),spawn,action);
    appendStderr(fileOutErr.getOutputFile(),fileOutErr.getErrorFile());
    finalizeTest(actionExecutionContext,action,data);
  }
 catch (  IOException e) {
    executor.getEventHandler().handle(Event.error("Caught I/O exception: " + e));
    throw new EnvironmentalExecException("unexpected I/O exception",e);
  }
 finally {
    if (resources != null) {
      ResourceManager.instance().releaseResources(action,resources);
    }
    try {
      if (fileOutErr != null) {
        fileOutErr.close();
      }
    }
 catch (    IOException e) {
    }
  }
}
