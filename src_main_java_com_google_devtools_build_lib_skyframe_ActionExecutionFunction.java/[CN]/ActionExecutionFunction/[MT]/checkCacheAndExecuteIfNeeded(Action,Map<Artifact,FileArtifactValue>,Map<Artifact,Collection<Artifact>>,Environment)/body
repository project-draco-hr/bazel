{
  FileAndMetadataCache fileAndMetadataCache=null;
  MetadataHandler metadataHandler=null;
  Token token=null;
  long actionStartTime=System.nanoTime();
  if (inputArtifactData != null) {
    fileAndMetadataCache=new FileAndMetadataCache(inputArtifactData,expandedMiddlemen,skyframeActionExecutor.getExecRoot(),action.getOutputs(),action.discoversInputs() ? env : null,tsgm);
    metadataHandler=skyframeActionExecutor.constructMetadataHandler(fileAndMetadataCache);
    token=skyframeActionExecutor.checkActionCache(action,metadataHandler,new PackageRootResolverWithEnvironment(env),actionStartTime);
    if (token == Token.NEED_TO_RERUN) {
      return null;
    }
  }
  if (token == null && inputArtifactData != null) {
    return new ActionExecutionValue(fileAndMetadataCache.getOutputData(),fileAndMetadataCache.getAdditionalOutputData());
  }
  ActionExecutionContext actionExecutionContext=null;
  try {
    if (inputArtifactData != null) {
      actionExecutionContext=skyframeActionExecutor.constructActionExecutionContext(fileAndMetadataCache,metadataHandler);
      if (action.discoversInputs()) {
        skyframeActionExecutor.discoverInputs(action,actionExecutionContext);
      }
    }
    return skyframeActionExecutor.executeAction(action,fileAndMetadataCache,token,actionStartTime,actionExecutionContext);
  }
  finally {
    try {
      if (actionExecutionContext != null) {
        actionExecutionContext.getFileOutErr().close();
      }
    }
 catch (    IOException e) {
    }
  }
}
