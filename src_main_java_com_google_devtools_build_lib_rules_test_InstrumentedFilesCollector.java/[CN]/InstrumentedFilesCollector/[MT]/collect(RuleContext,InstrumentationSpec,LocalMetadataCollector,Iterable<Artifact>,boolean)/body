{
  InstrumentedFilesCollector collector=new InstrumentedFilesCollector(ruleContext,spec,localMetadataCollector,rootFiles);
  NestedSet<Artifact> baselineCoverageArtifacts;
  if (withBaselineCoverage) {
    baselineCoverageArtifacts=BaselineCoverageAction.getBaselineCoverageArtifacts(ruleContext,collector.instrumentedFiles);
  }
 else {
    baselineCoverageArtifacts=NestedSetBuilder.<Artifact>emptySet(Order.STABLE_ORDER);
  }
  return new InstrumentedFilesProviderImpl(collector.instrumentedFiles,collector.instrumentationMetadataFiles,baselineCoverageArtifacts,ImmutableMap.<String,String>of());
}
