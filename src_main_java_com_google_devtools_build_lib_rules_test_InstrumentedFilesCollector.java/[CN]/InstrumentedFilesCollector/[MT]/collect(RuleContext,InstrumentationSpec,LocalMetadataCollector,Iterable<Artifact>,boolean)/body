{
  Preconditions.checkNotNull(ruleContext);
  Preconditions.checkNotNull(spec);
  if (!ruleContext.getConfiguration().isCodeCoverageEnabled()) {
    return InstrumentedFilesProviderImpl.EMPTY;
  }
  NestedSetBuilder<Artifact> instrumentedFilesBuilder=NestedSetBuilder.stableOrder();
  NestedSetBuilder<Artifact> metadataFilesBuilder=NestedSetBuilder.stableOrder();
  NestedSetBuilder<Artifact> baselineCoverageArtifactsBuilder=NestedSetBuilder.stableOrder();
  Iterable<TransitiveInfoCollection> prereqs=getAllPrerequisites(ruleContext,spec);
  for (  TransitiveInfoCollection dep : prereqs) {
    InstrumentedFilesProvider provider=dep.getProvider(InstrumentedFilesProvider.class);
    if (provider != null) {
      instrumentedFilesBuilder.addTransitive(provider.getInstrumentedFiles());
      metadataFilesBuilder.addTransitive(provider.getInstrumentationMetadataFiles());
      baselineCoverageArtifactsBuilder.addTransitive(provider.getBaselineCoverageArtifacts());
    }
  }
  NestedSet<Artifact> localSources=NestedSetBuilder.emptySet(Order.STABLE_ORDER);
  if (shouldIncludeLocalSources(ruleContext)) {
    NestedSetBuilder<Artifact> localSourcesBuilder=NestedSetBuilder.stableOrder();
    for (    TransitiveInfoCollection dep : prereqs) {
      if (dep.getProvider(InstrumentedFilesProvider.class) != null) {
        continue;
      }
      for (      Artifact artifact : dep.getProvider(FileProvider.class).getFilesToBuild()) {
        if (artifact.isSourceArtifact() && spec.instrumentedFileTypes.matches(artifact.getFilename())) {
          localSourcesBuilder.add(artifact);
        }
      }
    }
    localSources=localSourcesBuilder.build();
  }
  instrumentedFilesBuilder.addTransitive(localSources);
  if (localMetadataCollector != null) {
    localMetadataCollector.collectMetadataArtifacts(rootFiles,ruleContext.getAnalysisEnvironment(),metadataFilesBuilder);
  }
  if (withBaselineCoverage) {
    baselineCoverageArtifactsBuilder.addTransitive(BaselineCoverageAction.getBaselineCoverageArtifacts(ruleContext,localSources));
  }
  return new InstrumentedFilesProviderImpl(instrumentedFilesBuilder.build(),metadataFilesBuilder.build(),baselineCoverageArtifactsBuilder.build(),ImmutableMap.<String,String>of());
}
