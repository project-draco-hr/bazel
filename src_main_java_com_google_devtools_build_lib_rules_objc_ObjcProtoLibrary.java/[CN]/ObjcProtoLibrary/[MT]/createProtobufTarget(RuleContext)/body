{
  NestedSetBuilder<Artifact> filesToBuild=NestedSetBuilder.stableOrder();
  boolean experimentalAutoUnion=ObjcRuleClasses.objcConfiguration(ruleContext).experimentalAutoTopLevelUnionObjCProtos();
  ProtobufSupport protoSupport=new ProtobufSupport(ruleContext).registerGenerationActions().addFilesToBuild(filesToBuild);
  if (!experimentalAutoUnion) {
    protoSupport.registerCompilationActions();
  }
  XcodeProvider xcodeProvider=protoSupport.getXcodeProvider();
  new XcodeSupport(ruleContext).registerActions(xcodeProvider).addFilesToBuild(filesToBuild);
  return ObjcRuleClasses.ruleConfiguredTarget(ruleContext,filesToBuild.build()).addProvider(ObjcProvider.class,protoSupport.getObjcProvider()).addProvider(XcodeProvider.class,xcodeProvider).build();
}
