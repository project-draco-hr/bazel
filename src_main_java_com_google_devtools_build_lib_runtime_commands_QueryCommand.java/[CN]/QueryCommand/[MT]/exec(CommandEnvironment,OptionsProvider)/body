{
  BlazeRuntime runtime=env.getRuntime();
  QueryOptions queryOptions=options.getOptions(QueryOptions.class);
  try {
    env.setupPackageCache(options.getOptions(PackageCacheOptions.class),runtime.getDefaultsPackageContent());
  }
 catch (  InterruptedException e) {
    env.getReporter().handle(Event.error("query interrupted"));
    return ExitCode.INTERRUPTED;
  }
catch (  AbruptExitException e) {
    env.getReporter().handle(Event.error(null,"Unknown error: " + e.getMessage()));
    return e.getExitCode();
  }
  if (options.getResidue().isEmpty()) {
    env.getReporter().handle(Event.error(String.format("missing query expression. Type '%s help query' for syntax and help",Constants.PRODUCT_NAME)));
    return ExitCode.COMMAND_LINE_ERROR;
  }
  Iterable<OutputFormatter> formatters=runtime.getQueryOutputFormatters();
  OutputFormatter formatter=OutputFormatter.getFormatter(formatters,queryOptions.outputFormat);
  if (formatter == null) {
    env.getReporter().handle(Event.error(String.format("Invalid output format '%s'. Valid values are: %s",queryOptions.outputFormat,OutputFormatter.formatterNames(formatters))));
    return ExitCode.COMMAND_LINE_ERROR;
  }
  String query=Joiner.on(' ').join(options.getResidue());
  Set<Setting> settings=queryOptions.toSettings();
  AbstractBlazeQueryEnvironment<Target> queryEnv=newQueryEnvironment(env,queryOptions.keepGoing,QueryOutputUtils.orderResults(queryOptions,formatter),queryOptions.universeScope,queryOptions.loadingPhaseThreads,settings);
  QueryExpression expr;
  try {
    expr=QueryExpression.parse(query,queryEnv);
  }
 catch (  QueryException e) {
    env.getReporter().handle(Event.error(null,"Error while parsing '" + query + "': "+ e.getMessage()));
    return ExitCode.COMMAND_LINE_ERROR;
  }
  QueryEvalResult<Target> result;
  try {
    result=queryEnv.evaluateQuery(expr);
  }
 catch (  QueryException|InterruptedException e) {
    env.getReporter().handle(Event.error(e.getMessage() == null ? e.toString() : e.getMessage()));
    return ExitCode.ANALYSIS_FAILURE;
  }
  env.getReporter().switchToAnsiAllowingHandler();
  PrintStream output=new PrintStream(env.getReporter().getOutErr().getOutputStream());
  try {
    QueryOutputUtils.output(queryOptions,result,formatter,output,queryOptions.aspectDeps.createResolver(env.getPackageManager(),env.getReporter()));
  }
 catch (  ClosedByInterruptException|InterruptedException e) {
    env.getReporter().handle(Event.error("query interrupted"));
    return ExitCode.INTERRUPTED;
  }
catch (  IOException e) {
    env.getReporter().handle(Event.error("I/O error: " + e.getMessage()));
    return ExitCode.LOCAL_ENVIRONMENTAL_ERROR;
  }
 finally {
    output.flush();
  }
  if (result.getResultSet().isEmpty()) {
    env.getReporter().handle(Event.info("Empty results"));
  }
  return result.getSuccess() ? ExitCode.SUCCESS : ExitCode.PARTIAL_ANALYSIS_FAILURE;
}
