{
  Target target=targetAndErrorIfAny.getTarget();
  NoSuchTargetException errorLoadingTarget=targetAndErrorIfAny.getErrorLoadingTarget();
  if (target instanceof Rule) {
    ConfigurationFragmentPolicy configurationFragmentPolicy=target.getAssociatedRule().getRuleClassObject().getConfigurationFragmentPolicy();
    Set<Class<?>> configFragments=configurationFragmentPolicy.getRequiredConfigurationFragments();
    configFragments=configFragments.isEmpty() ? getAllFragments() : configFragments;
    for (    Class<?> fragment : configFragments) {
      if (!builder.getConfigFragmentsFromDeps().contains(fragment)) {
        builder.getTransitiveConfigFragments().add(fragment.asSubclass(BuildConfiguration.Fragment.class));
      }
    }
  }
  return builder.build(errorLoadingTarget);
}
