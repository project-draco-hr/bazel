{
  Target target=targetAndErrorIfAny.getTarget();
  NoSuchTargetException errorLoadingTarget=targetAndErrorIfAny.getErrorLoadingTarget();
  if (target instanceof Rule) {
    ConfigurationFragmentPolicy configurationFragmentPolicy=target.getAssociatedRule().getRuleClassObject().getConfigurationFragmentPolicy();
    for (    ConfigurationFragmentFactory factory : ruleClassProvider.getConfigurationFragments()) {
      Class<? extends Fragment> fragment=factory.creates();
      if (configurationFragmentPolicy.isLegalConfigurationFragment(fragment) && !builder.getConfigFragmentsFromDeps().contains(fragment)) {
        builder.getTransitiveConfigFragments().add(fragment.asSubclass(BuildConfiguration.Fragment.class));
      }
    }
    Rule rule=(Rule)target;
    if (rule.getRuleClass().equals(ConfigSettingRule.RULE_NAME)) {
      builder.getTransitiveConfigFragments().addAll(ConfigSettingRule.requiresConfigurationFragments(rule,optionsToFragmentMap));
    }
    Class<? extends Fragment> universalFragment=ruleClassProvider.getUniversalFragment().asSubclass(BuildConfiguration.Fragment.class);
    if (!builder.getConfigFragmentsFromDeps().contains(universalFragment)) {
      builder.getTransitiveConfigFragments().add(universalFragment);
    }
  }
  return builder.build(errorLoadingTarget);
}
