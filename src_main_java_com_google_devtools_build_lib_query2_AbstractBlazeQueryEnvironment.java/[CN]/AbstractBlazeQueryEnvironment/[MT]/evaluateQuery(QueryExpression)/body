{
  Set<T> resultNodes;
  try (AutoProfiler p=AutoProfiler.logged("evaluating query",LOG)){
    resolvedTargetPatterns.clear();
    Set<String> targetPatternSet=new LinkedHashSet<>();
    expr.collectTargetPatterns(targetPatternSet);
    try {
      resolvedTargetPatterns.putAll(preloadOrThrow(expr,targetPatternSet));
    }
 catch (    TargetParsingException e) {
      throw new QueryException(expr,e.getMessage());
    }
    try {
      resultNodes=QueryUtil.evalAll(this,expr);
    }
 catch (    QueryException e) {
      throw new QueryException(e,expr);
    }
  }
   if (eventHandler.hasErrors()) {
    if (!keepGoing) {
      throw new QueryException("Evaluation of query \"" + expr + "\" failed due to BUILD file errors");
    }
 else {
      eventHandler.handle(Event.warn("--keep_going specified, ignoring errors.  " + "Results may be inaccurate"));
    }
  }
  return new QueryEvalResult<>(!eventHandler.hasErrors(),resultNodes);
}
