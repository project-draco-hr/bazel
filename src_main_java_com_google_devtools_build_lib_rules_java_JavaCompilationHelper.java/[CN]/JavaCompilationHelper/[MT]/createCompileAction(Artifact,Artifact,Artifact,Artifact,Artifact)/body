{
  JavaTargetAttributes attributes=getAttributes();
  JavaCompileAction.Builder builder=createJavaCompileActionBuilder(semantics);
  builder.setClasspathEntries(attributes.getCompileTimeClassPath());
  builder.addResources(attributes.getResources());
  builder.addClasspathResources(attributes.getClassPathResources());
  builder.setBootclasspathEntries(getBootclasspathOrDefault());
  builder.setExtdirInputs(getExtdirInputs());
  builder.setLangtoolsJar(javaToolchain.getJavac());
  builder.setJavaBuilderJar(javaToolchain.getJavaBuilder());
  builder.addTranslations(getTranslations());
  builder.setOutputJar(outputJar);
  builder.setManifestProtoOutput(manifestProtoOutput);
  builder.setGensrcOutputJar(gensrcOutputJar);
  builder.setOutputDepsProto(outputDepsProto);
  builder.setMetadata(outputMetadata);
  builder.setInstrumentationJars(getInstrumentationJars());
  builder.addSourceFiles(attributes.getSourceFiles());
  builder.addSourceJars(attributes.getSourceJars());
  builder.setJavacOpts(customJavacOpts);
  builder.setJavacJvmOpts(customJavacJvmOpts);
  builder.setJavacExecutionInfo(getExecutionInfo());
  builder.setCompressJar(true);
  builder.setSourceGenDirectory(sourceGenDir(outputJar));
  builder.setTempDirectory(tempDir(outputJar));
  builder.setClassDirectory(classDir(outputJar));
  builder.addProcessorPaths(attributes.getProcessorPath());
  builder.addProcessorNames(attributes.getProcessorNames());
  builder.setStrictJavaDeps(attributes.getStrictJavaDeps());
  builder.setDirectJars(attributes.getDirectJars());
  builder.addCompileTimeDependencyArtifacts(attributes.getCompileTimeDependencyArtifacts());
  builder.setRuleKind(attributes.getRuleKind());
  builder.setTargetLabel(attributes.getTargetLabel());
  getAnalysisEnvironment().registerAction(builder.build());
}
