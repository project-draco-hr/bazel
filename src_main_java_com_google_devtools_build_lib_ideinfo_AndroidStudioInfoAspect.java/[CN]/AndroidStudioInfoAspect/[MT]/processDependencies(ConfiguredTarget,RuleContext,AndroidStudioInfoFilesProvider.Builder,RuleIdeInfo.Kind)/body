{
  NestedSetBuilder<Label> dependenciesBuilder=NestedSetBuilder.stableOrder();
  ImmutableList.Builder<TransitiveInfoCollection> prerequisitesBuilder=ImmutableList.builder();
  if (ruleContext.attributes().has("deps",BuildType.LABEL_LIST)) {
    prerequisitesBuilder.addAll(ruleContext.getPrerequisites("deps",Mode.TARGET));
  }
  if (ruleContext.attributes().has("exports",BuildType.LABEL_LIST)) {
    prerequisitesBuilder.addAll(ruleContext.getPrerequisites("exports",Mode.TARGET));
  }
  List<TransitiveInfoCollection> prerequisites=prerequisitesBuilder.build();
  for (  AndroidStudioInfoFilesProvider depProvider : AnalysisUtils.getProviders(prerequisites,AndroidStudioInfoFilesProvider.class)) {
    dependenciesBuilder.addTransitive(depProvider.getExportedDeps());
    providerBuilder.ideInfoFilesBuilder().addTransitive(depProvider.getIdeInfoFiles());
    providerBuilder.ideInfoTextFilesBuilder().addTransitive(depProvider.getIdeInfoTextFiles());
    providerBuilder.ideResolveFilesBuilder().addTransitive(depProvider.getIdeResolveFiles());
    providerBuilder.transitiveDependenciesBuilder().addTransitive(depProvider.getTransitiveDependencies());
    providerBuilder.transitiveResourcesBuilder().addTransitive(depProvider.getTransitiveResources());
  }
  for (  TransitiveInfoCollection dep : prerequisites) {
    dependenciesBuilder.add(dep.getLabel());
  }
  JavaExportsProvider javaExportsProvider=base.getProvider(JavaExportsProvider.class);
  if (javaExportsProvider != null) {
    providerBuilder.exportedDepsBuilder().addTransitive(javaExportsProvider.getTransitiveExports());
  }
  if (ruleKind == Kind.ANDROID_LIBRARY) {
    JavaSourceInfoProvider sourceInfoProvider=base.getProvider(JavaSourceInfoProvider.class);
    boolean hasSources=sourceInfoProvider != null && !sourceInfoProvider.getSourceFiles().isEmpty();
    if (!hasSources) {
      for (      TransitiveInfoCollection dep : prerequisites) {
        providerBuilder.exportedDepsBuilder().add(dep.getLabel());
      }
    }
  }
  NestedSet<Label> directDependencies=dependenciesBuilder.build();
  providerBuilder.transitiveDependenciesBuilder().addTransitive(directDependencies);
  return directDependencies;
}
