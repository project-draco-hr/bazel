{
  Artifact classesDex=AndroidBinary.getDxArtifact(ruleContext,getMultidexMode(ruleContext).getOutputDexFilename());
  if (!AndroidBinary.supportsMultidexMode(ruleContext,multidexMode)) {
    ruleContext.ruleError("Multidex mode \"" + multidexMode.getAttributeValue() + "\" not supported by this version of the Android SDK");
    throw new RuleConfigurationException();
  }
  int dexShards=ruleContext.attributes().get("dex_shards",Type.INTEGER);
  if (dexShards > 1 && multidexMode == MultidexMode.OFF) {
    ruleContext.ruleError(".dex sharding is only available in multidex mode");
    throw new RuleConfigurationException();
  }
  Artifact mainDexList=ruleContext.getPrerequisiteArtifact("main_dex_list",Mode.TARGET);
  if ((mainDexList != null && multidexMode != MultidexMode.MANUAL_MAIN_DEX) || (mainDexList == null && multidexMode == MultidexMode.MANUAL_MAIN_DEX)) {
    ruleContext.ruleError("Both \"main_dex_list\" and \"multidex='manual_main_dex'\" must be specified.");
    throw new RuleConfigurationException();
  }
  if (multidexMode == MultidexMode.OFF) {
    AndroidCommon.createDexAction(ruleContext,proguardedJar,classesDex,dexopts,false,null);
    return new DexingOutput(classesDex,deployJar,ImmutableList.of(classesDex));
  }
 else {
    if (multidexMode == MultidexMode.LEGACY) {
      mainDexList=createMainDexListAction(ruleContext,proguardedJar);
    }
    if (dexShards > 1) {
      List<Artifact> shardJars=new ArrayList<>(dexShards);
      for (int i=1; i <= dexShards; i++) {
        shardJars.add(getDxArtifact(ruleContext,"shard" + i + ".jar"));
      }
      CustomCommandLine.Builder shardCommandLine=CustomCommandLine.builder().addBeforeEachExecPath("--output_jar",shardJars);
      Artifact javaResourceJar=ruleContext.getImplicitOutputArtifact(AndroidRuleClasses.JAVA_RESOURCES_JAR);
      if (mainDexList != null) {
        shardCommandLine.addExecPath("--main_dex_filter",mainDexList);
      }
      if (proguardedJar != deployJar) {
        shardCommandLine.addExecPath("--input_jar",proguardedJar);
      }
 else {
        shardCommandLine.addBeforeEachExecPath("--input_jar",common.getRuntimeJars()).addBeforeEachExecPath("--input_jar",attributes.getRuntimeClassPathForArchive());
      }
      shardCommandLine.addExecPath("--output_resources",javaResourceJar);
      SpawnAction.Builder shardAction=new SpawnAction.Builder().setMnemonic("ShardClassesToDex").setProgressMessage("Sharding classes for dexing for " + ruleContext.getLabel()).setExecutable(ruleContext.getExecutablePrerequisite("$shuffle_jars",Mode.HOST)).addOutputs(shardJars).addOutput(javaResourceJar).setCommandLine(shardCommandLine.build());
      if (mainDexList != null) {
        shardAction.addInput(mainDexList);
      }
      if (proguardedJar != deployJar) {
        shardAction.addInput(proguardedJar);
      }
 else {
        shardAction.addInputs(common.getRuntimeJars()).addInputs(attributes.getRuntimeClassPathForArchive());
      }
      ruleContext.registerAction(shardAction.build(ruleContext));
      List<Artifact> shardDexes=new ArrayList<>(dexShards);
      for (int i=1; i <= dexShards; i++) {
        Artifact shardJar=shardJars.get(i - 1);
        Artifact shard=getDxArtifact(ruleContext,"shard" + i + ".dex.zip");
        shardDexes.add(shard);
        AndroidCommon.createDexAction(ruleContext,shardJar,shard,dexopts,true,null);
      }
      CommandLine mergeCommandLine=CustomCommandLine.builder().addBeforeEachExecPath("--input_zip",shardDexes).addExecPath("--output_zip",classesDex).build();
      ruleContext.registerAction(new SpawnAction.Builder().setMnemonic("MergeDexZips").setProgressMessage("Merging dex shards for " + ruleContext.getLabel()).setExecutable(ruleContext.getExecutablePrerequisite("$merge_dexzips",Mode.HOST)).addInputs(shardDexes).addOutput(classesDex).setCommandLine(mergeCommandLine).build(ruleContext));
      return new DexingOutput(classesDex,javaResourceJar,shardDexes);
    }
 else {
      PathFragment dexPath=classesDex.getRootRelativePath();
      Artifact classesDexIntermediate=ruleContext.getAnalysisEnvironment().getDerivedArtifact(dexPath.getParentDirectory().getRelative("intermediate_" + dexPath.getBaseName()),ruleContext.getBinOrGenfilesDirectory());
      AndroidCommon.createDexAction(ruleContext,proguardedJar,classesDexIntermediate,dexopts,true,mainDexList);
      createCleanDexZipAction(ruleContext,classesDexIntermediate,classesDex);
      return new DexingOutput(classesDex,deployJar,ImmutableList.of(classesDex));
    }
  }
}
