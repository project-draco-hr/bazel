{
  Artifact strippedJar=AndroidBinary.getDxArtifact(ruleContext,"main_dex_intermediate.jar");
  AndroidSdkProvider sdk=AndroidSdkProvider.fromRuleContext(ruleContext);
  ruleContext.registerAction(new SpawnAction.Builder().addOutput(strippedJar).setExecutable(sdk.getProguard()).setProgressMessage("Generating streamlined input jar for main dex classes list").setMnemonic("MainDexClassesIntermediate").addArgument("-injars").addInputArgument(jar).addArgument("-libraryjars").addInputArgument(sdk.getShrinkedAndroidJar()).addArgument("-outjars").addArgument(strippedJar.getExecPathString()).addArgument("-dontwarn").addArgument("-dontnote").addArgument("-forceprocessing").addArgument("-dontoptimize").addArgument("-dontobfuscate").addArgument("-dontpreverify").addArgument("-include").addInputArgument(sdk.getMainDexClasses()).build(ruleContext));
  Artifact mainDexList=AndroidBinary.getDxArtifact(ruleContext,"main_dex_list.txt");
  Builder builder=new Builder().setMnemonic("MainDexClasses").setProgressMessage("Generating main dex classes list");
  ruleContext.registerAction(builder.setExecutable(sdk.getMainDexListCreator()).addOutputArgument(mainDexList).addInputArgument(strippedJar).addInputArgument(jar).addArguments(ruleContext.getTokenizedStringListAttr("main_dex_list_opts")).build(ruleContext));
  return mainDexList;
}
