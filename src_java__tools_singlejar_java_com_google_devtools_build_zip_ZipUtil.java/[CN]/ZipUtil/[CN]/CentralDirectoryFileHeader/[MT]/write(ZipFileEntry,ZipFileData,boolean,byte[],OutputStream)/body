{
  if (buf == null || buf.length < FIXED_DATA_SIZE) {
    buf=new byte[FIXED_DATA_SIZE];
  }
  if (allowZip64) {
    addZip64Extra(entry);
  }
 else {
    entry.getExtra().remove((short)0x0001);
  }
  byte[] name=entry.getName().getBytes(file.getCharset());
  byte[] extra=entry.getExtra().getBytes();
  byte[] comment=entry.getComment() != null ? entry.getComment().getBytes(file.getCharset()) : new byte[]{};
  fillFixedSizeData(buf,entry,name.length,extra.length,comment.length,allowZip64);
  stream.write(buf,0,FIXED_DATA_SIZE);
  stream.write(name);
  stream.write(extra);
  stream.write(comment);
  return FIXED_DATA_SIZE + name.length + extra.length+ comment.length;
}
