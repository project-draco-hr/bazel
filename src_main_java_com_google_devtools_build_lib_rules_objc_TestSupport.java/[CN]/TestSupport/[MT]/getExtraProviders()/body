{
  AppleConfiguration configuration=ruleContext.getFragment(AppleConfiguration.class);
  ImmutableMap.Builder<String,String> envBuilder=ImmutableMap.builder();
  envBuilder.putAll(configuration.getEnvironmentForIosAction());
  envBuilder.putAll(configuration.getAppleHostSystemEnv());
  if (ruleContext.getConfiguration().isCodeCoverageEnabled()) {
    envBuilder.put("COVERAGE_GCOV_PATH",ruleContext.getHostPrerequisiteArtifact(IosTest.GCOV_ATTR).getExecPathString());
    envBuilder.put("APPLE_COVERAGE","1");
  }
  return ImmutableMap.<Class<? extends TransitiveInfoProvider>,TransitiveInfoProvider>of(TestEnvironmentProvider.class,new TestEnvironmentProvider(envBuilder.build()));
}
