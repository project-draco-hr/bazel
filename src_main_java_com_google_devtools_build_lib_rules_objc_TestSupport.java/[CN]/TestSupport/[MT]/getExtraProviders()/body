{
  AppleConfiguration configuration=ruleContext.getFragment(AppleConfiguration.class);
  XcodeConfigProvider xcodeConfigProvider=ruleContext.getPrerequisite(":xcode_config",Mode.HOST,XcodeConfigProvider.class);
  ImmutableMap.Builder<String,String> envBuilder=ImmutableMap.builder();
  envBuilder.putAll(configuration.getEnvironmentForIosAction());
  envBuilder.putAll(AppleToolchain.appleHostSystemEnv(xcodeConfigProvider));
  if (ruleContext.getConfiguration().isCodeCoverageEnabled()) {
    envBuilder.put("COVERAGE_GCOV_PATH",ruleContext.getHostPrerequisiteArtifact(":gcov").getExecPathString());
  }
  return ImmutableMap.<Class<? extends TransitiveInfoProvider>,TransitiveInfoProvider>of(TestEnvironmentProvider.class,new TestEnvironmentProvider(envBuilder.build()));
}
