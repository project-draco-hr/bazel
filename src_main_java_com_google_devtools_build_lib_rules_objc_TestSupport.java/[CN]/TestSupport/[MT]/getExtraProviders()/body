{
  ObjcConfiguration configuration=ruleContext.getFragment(ObjcConfiguration.class);
  ImmutableMap.Builder<String,String> envBuilder=ImmutableMap.builder();
  envBuilder.putAll(configuration.getEnvironmentForDarwin());
  if (ruleContext.getConfiguration().isCodeCoverageEnabled()) {
    envBuilder.put("COVERAGE_GCOV_PATH",ruleContext.getHostPrerequisiteArtifact(":gcov").getExecPathString());
  }
  return ImmutableMap.<Class<? extends TransitiveInfoProvider>,TransitiveInfoProvider>of(TestEnvironmentProvider.class,new TestEnvironmentProvider(envBuilder.build()));
}
