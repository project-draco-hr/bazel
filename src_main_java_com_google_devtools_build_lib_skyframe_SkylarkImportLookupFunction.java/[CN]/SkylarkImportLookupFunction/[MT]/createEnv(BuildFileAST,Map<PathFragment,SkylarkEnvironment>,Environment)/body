{
  StoredEventHandler eventHandler=new StoredEventHandler();
  SkylarkEnvironment extensionEnv=ruleClassProvider.createSkylarkRuleClassEnvironment(eventHandler,ast.getContentHashCode());
  extensionEnv.update("native",ruleClassProvider.getNativeModule());
  for (  Function function : nativeRuleFunctions) {
    extensionEnv.registerFunction(ruleClassProvider.getNativeModule().getClass(),function.getName(),function);
  }
  extensionEnv.setImportedExtensions(importMap);
  ast.exec(extensionEnv,eventHandler);
  Event.replayEventsOn(env.getListener(),eventHandler.getEvents());
  return extensionEnv;
}
