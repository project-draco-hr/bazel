{
  StoredEventHandler eventHandler=new StoredEventHandler();
  SkylarkEnvironment extensionEnv=ruleClassProvider.createSkylarkRuleClassEnvironment(eventHandler,ast.getContentHashCode());
  for (  BaseFunction function : nativeRuleFunctions) {
    extensionEnv.registerFunction(SkylarkNativeModule.class,function.getName(),function);
  }
  extensionEnv.setImportedExtensions(importMap);
  ast.exec(extensionEnv,eventHandler);
  SkylarkRuleClassFunctions.exportRuleFunctions(extensionEnv,file);
  Event.replayEventsOn(env.getListener(),eventHandler.getEvents());
  if (eventHandler.hasErrors()) {
    throw new SkylarkImportLookupFunctionException(SkylarkImportFailedException.errors(file));
  }
  return extensionEnv;
}
