{
  StoredEventHandler eventHandler=new StoredEventHandler();
  try (Mutability mutability=Mutability.create("importing %s",file)){
    com.google.devtools.build.lib.syntax.Environment extensionEnv=ruleClassProvider.createSkylarkRuleClassEnvironment(mutability,eventHandler,ast.getContentHashCode(),importMap).setupOverride("native",packageFactory.getNativeModule());
    ast.exec(extensionEnv,eventHandler);
    SkylarkRuleClassFunctions.exportRuleFunctions(extensionEnv,file);
    Event.replayEventsOn(env.getListener(),eventHandler.getEvents());
    if (eventHandler.hasErrors()) {
      throw new SkylarkImportLookupFunctionException(SkylarkImportFailedException.errors(file));
    }
    return extensionEnv;
  }
 }
