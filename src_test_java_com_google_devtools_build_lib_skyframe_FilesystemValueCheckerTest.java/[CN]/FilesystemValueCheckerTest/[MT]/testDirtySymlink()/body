{
  FilesystemValueChecker checker=new FilesystemValueChecker(evaluator,tsgm,null);
  Path path=fs.getPath("/foo");
  FileSystemUtils.writeContentAsLatin1(path,"foo contents");
  Path sym1=fs.getPath("/sym1");
  Path sym2=fs.getPath("/sym2");
  Path symlink=fs.getPath("/bar");
  FileSystemUtils.ensureSymbolicLink(symlink,sym1);
  FileSystemUtils.ensureSymbolicLink(sym1,path);
  FileSystemUtils.ensureSymbolicLink(sym2,path);
  SkyKey fooKey=FileValue.key(RootedPath.toRootedPath(fs.getRootDirectory(),new PathFragment("foo")));
  RootedPath symlinkRootedPath=RootedPath.toRootedPath(fs.getRootDirectory(),new PathFragment("bar"));
  SkyKey symlinkKey=FileValue.key(symlinkRootedPath);
  SkyKey symlinkFileStateKey=FileStateValue.key(symlinkRootedPath);
  RootedPath sym1RootedPath=RootedPath.toRootedPath(fs.getRootDirectory(),new PathFragment("sym1"));
  SkyKey sym1FileStateKey=FileStateValue.key(sym1RootedPath);
  Iterable<SkyKey> allKeys=ImmutableList.of(symlinkKey,fooKey);
  EvaluationResult<FileValue> result=driver.evaluate(allKeys,false,SkyframeExecutor.DEFAULT_THREAD_COUNT,NullEventHandler.INSTANCE);
  assertFalse(result.hasError());
  FileValue symlinkValue=result.get(symlinkKey);
  FileValue fooValue=result.get(fooKey);
  assertTrue(symlinkValue.toString(),symlinkValue.isSymlink());
  assertEquals(fooValue.getSize(),symlinkValue.getSize());
  assertEmptyDiff(getDirtyFilesystemKeys(checker));
  assertTrue(sym1.delete());
  FileSystemUtils.ensureSymbolicLink(sym1,sym2);
  assertDiffWithNewValues(getDirtyFilesystemKeys(checker),sym1FileStateKey);
  differencer.invalidate(ImmutableList.of(sym1FileStateKey));
  result=driver.evaluate(ImmutableList.<SkyKey>of(),false,SkyframeExecutor.DEFAULT_THREAD_COUNT,NullEventHandler.INSTANCE);
  assertFalse(result.hasError());
  assertDiffWithNewValues(getDirtyFilesystemKeys(checker),sym1FileStateKey);
  assertTrue(sym1.delete());
  FileSystemUtils.ensureSymbolicLink(sym1,path);
  assertTrue(symlink.delete());
  FileSystemUtils.writeContentAsLatin1(symlink,"new symlink contents");
  assertDiffWithNewValues(getDirtyFilesystemKeys(checker),symlinkFileStateKey);
  differencer.invalidate(ImmutableList.of(symlinkFileStateKey));
  result=driver.evaluate(allKeys,false,SkyframeExecutor.DEFAULT_THREAD_COUNT,NullEventHandler.INSTANCE);
  assertFalse(result.hasError());
  symlinkValue=result.get(symlinkKey);
  assertFalse(symlinkValue.toString(),symlinkValue.isSymlink());
  assertEquals(fooValue,result.get(fooKey));
  assertThat(symlinkValue.getSize()).isNotEqualTo(fooValue.getSize());
  assertEmptyDiff(getDirtyFilesystemKeys(checker));
}
