{
  int fileSizeKBytes=(int)(file.getFileSize() / 1024);
  Preconditions.checkArgument(fileSizeKBytes < MAX_MEMORY_KBYTES);
  try {
    uploadMemoryAvailable.acquire(fileSizeKBytes);
    try (InputStream stream=file.getInputStream()){
      cache.put(key,CacheEntry.newBuilder().setFileContent(ByteString.readFrom(stream)).build().toByteArray());
    }
   }
 catch (  InterruptedException e) {
    throw new IOException("Failed to put file to memory cache.",e);
  }
 finally {
    uploadMemoryAvailable.release(fileSizeKBytes);
  }
}
