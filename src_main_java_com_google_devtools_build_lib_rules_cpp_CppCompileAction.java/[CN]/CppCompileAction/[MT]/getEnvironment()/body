{
  Map<String,String> environment=new LinkedHashMap<>(configuration.getLocalShellEnvironment());
  if (configuration.isCodeCoverageEnabled()) {
    environment.put("PWD","/proc/self/cwd");
  }
  AppleConfiguration appleConfiguration=configuration.getFragment(AppleConfiguration.class);
  if (CppConfiguration.MAC_SYSTEM_NAME.equals(getHostSystemName())) {
    environment.putAll(appleConfiguration.getAppleHostSystemEnv());
  }
  if (Platform.isApplePlatform(cppConfiguration.getTargetCpu())) {
    environment.putAll(appleConfiguration.appleTargetPlatformEnv(Platform.forTargetCpu(cppConfiguration.getTargetCpu())));
  }
  environment.putAll(cppCompileCommandLine.getEnvironment());
  if (OS.getCurrent() == OS.WINDOWS) {
    environment.put("PATH",cppConfiguration.getToolPathFragment(Tool.GCC).getParentDirectory().getPathString());
  }
  return ImmutableMap.copyOf(environment);
}
