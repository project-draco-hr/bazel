{
  List<String> options=new ArrayList<>();
  CppConfiguration toolchain=cppConfiguration;
  options.addAll(pluginOpts);
  addFilteredOptions(options,toolchain.getCompilerOptions(features));
  if (isInstrumented) {
    addFilteredOptions(options,ImmutableList.of("-fprofile-arcs","-ftest-coverage"));
  }
  String sourceFilename=sourceFile.getExecPathString();
  if (CppFileTypes.C_SOURCE.matches(sourceFilename)) {
    addFilteredOptions(options,toolchain.getCOptions());
  }
  if (CppFileTypes.CPP_SOURCE.matches(sourceFilename) || CppFileTypes.CPP_HEADER.matches(sourceFilename) || CppFileTypes.CPP_MODULE_MAP.matches(sourceFilename)) {
    addFilteredOptions(options,toolchain.getCxxOptions(features));
  }
  options.addAll(copts);
  for (  String warn : cppConfiguration.getCWarns()) {
    options.add("-W" + warn);
  }
  for (  String define : context.getDefines()) {
    options.add("-D" + define);
  }
  if (fdoBuildStamp != null) {
    options.add("-D" + CppConfiguration.FDO_STAMP_MACRO + "=\""+ fdoBuildStamp+ "\"");
  }
  CcToolchainFeatures.Variables.Builder buildVariables=new CcToolchainFeatures.Variables.Builder();
  if (featureConfiguration.isEnabled(CppRuleClasses.MODULE_MAPS) && cppModuleMap != null) {
    buildVariables.addVariable("module_name",cppModuleMap.getName());
    buildVariables.addVariable("module_map_file",cppModuleMap.getArtifact().getExecPathString());
  }
  if (featureConfiguration.isEnabled(CppRuleClasses.USE_HEADER_MODULES)) {
    buildVariables.addSequenceVariable("module_files",getHeaderModulePaths());
  }
  if (featureConfiguration.isEnabled(CppRuleClasses.INCLUDE_PATHS)) {
    buildVariables.addSequenceVariable("include_paths",getSafePathStrings(context.getIncludeDirs()));
    buildVariables.addSequenceVariable("quote_include_paths",getSafePathStrings(context.getQuoteIncludeDirs()));
    buildVariables.addSequenceVariable("system_include_paths",getSafePathStrings(context.getSystemIncludeDirs()));
  }
  options.addAll(featureConfiguration.getCommandLine(getActionName(),buildVariables.build()));
  options.addAll(toolchain.getUnfilteredCompilerOptions(features));
  options.add("-frandom-seed=" + outputFile.getExecPathString());
  for (  PerLabelOptions perLabelOptions : cppConfiguration.getPerFileCopts()) {
    if ((sourceLabel != null && perLabelOptions.isIncluded(sourceLabel)) || perLabelOptions.isIncluded(sourceFile)) {
      options.addAll(perLabelOptions.getOptions());
    }
  }
  if (dotdFile != null) {
    options.add("-MD");
    options.add("-MF");
    options.add(dotdFile.getSafeExecPath().getPathString());
  }
  if (FileType.contains(outputFile,CppFileTypes.ASSEMBLER,CppFileTypes.PIC_ASSEMBLER)) {
    options.add("-S");
  }
 else   if (FileType.contains(outputFile,CppFileTypes.PREPROCESSED_C,CppFileTypes.PREPROCESSED_CPP,CppFileTypes.PIC_PREPROCESSED_C,CppFileTypes.PIC_PREPROCESSED_CPP)) {
    options.add("-E");
  }
  if (cppConfiguration.useFission()) {
    options.add("-gsplit-dwarf");
  }
  if (usePic) {
    options.add("-fPIC");
  }
  return options;
}
