{
  List<String> options=new ArrayList<>();
  if (CppFileTypes.CPP_MODULE_MAP.matches(sourceFile.getExecPath())) {
    if (!featureConfiguration.isEnabled(CppRuleClasses.HEADER_MODULES)) {
      options.add("-x");
      options.add("c++");
      options.add("-Xclang=-emit-module");
      options.add("-Xcrosstool-module-compilation");
    }
  }
 else   if (CppFileTypes.CPP_HEADER.matches(sourceFile.getExecPath())) {
    if (features.contains(CppRuleClasses.PARSE_HEADERS)) {
      if (!featureConfiguration.isEnabled(CppRuleClasses.PARSE_HEADERS)) {
        options.add("-x");
        options.add("c++-header");
        options.add("-fsyntax-only");
      }
    }
 else     if (features.contains(CppRuleClasses.PREPROCESS_HEADERS)) {
      if (!featureConfiguration.isEnabled(CppRuleClasses.PREPROCESS_HEADERS)) {
        options.add("-E");
        options.add("-x");
        options.add("c++");
      }
    }
 else {
      throw new IllegalStateException();
    }
  }
  for (  PathFragment quoteIncludePath : context.getQuoteIncludeDirs()) {
    options.add("-iquote");
    options.add(quoteIncludePath.getSafePathString());
  }
  for (  PathFragment includePath : context.getIncludeDirs()) {
    options.add("-I" + includePath.getSafePathString());
  }
  for (  PathFragment systemIncludePath : context.getSystemIncludeDirs()) {
    options.add("-isystem");
    options.add(systemIncludePath.getSafePathString());
  }
  CppConfiguration toolchain=cppConfiguration;
  options.addAll(pluginOpts);
  addFilteredOptions(options,toolchain.getCompilerOptions(features));
  if (isInstrumented) {
    addFilteredOptions(options,ImmutableList.of("-fprofile-arcs","-ftest-coverage"));
  }
  String sourceFilename=sourceFile.getExecPathString();
  if (CppFileTypes.C_SOURCE.matches(sourceFilename)) {
    addFilteredOptions(options,toolchain.getCOptions());
  }
  if (CppFileTypes.CPP_SOURCE.matches(sourceFilename) || CppFileTypes.CPP_HEADER.matches(sourceFilename) || CppFileTypes.CPP_MODULE_MAP.matches(sourceFilename)) {
    addFilteredOptions(options,toolchain.getCxxOptions(features));
  }
  options.addAll(copts);
  for (  String warn : cppConfiguration.getCWarns()) {
    options.add("-W" + warn);
  }
  for (  String define : context.getDefines()) {
    options.add("-D" + define);
  }
  if (fdoBuildStamp != null) {
    options.add("-D" + CppConfiguration.FDO_STAMP_MACRO + "=\""+ fdoBuildStamp+ "\"");
  }
  options.addAll(toolchain.getUnfilteredCompilerOptions(features));
  options.add("-frandom-seed=" + outputFile.getExecPathString());
  for (  PerLabelOptions perLabelOptions : cppConfiguration.getPerFileCopts()) {
    if ((sourceLabel != null && perLabelOptions.isIncluded(sourceLabel)) || perLabelOptions.isIncluded(sourceFile)) {
      options.addAll(perLabelOptions.getOptions());
    }
  }
  if (dotdFile != null) {
    options.add("-MD");
    options.add("-MF");
    options.add(dotdFile.getSafeExecPath().getPathString());
  }
  if (cppModuleMap != null && (compileHeaderModules || enableLayeringCheck)) {
    if (!featureConfiguration.isEnabled(CppRuleClasses.MODULE_MAPS)) {
      options.add("-Xclang-only=-fmodule-maps");
      options.add("-Xclang-only=-fmodule-name=" + cppModuleMap.getName());
      options.add("-Xclang-only=-fmodule-map-file=" + cppModuleMap.getArtifact().getExecPathString());
      options.add("-Xclang=-fno-modules-implicit-maps");
    }
    if (compileHeaderModules && !featureConfiguration.isEnabled(CppRuleClasses.HEADER_MODULES)) {
      options.add("-Xclang-only=-fmodules");
      for (      String headerModulePath : getHeaderModulePaths()) {
        options.add("-Xclang=-fmodule-file=" + headerModulePath);
      }
    }
    if (enableLayeringCheck && !featureConfiguration.isEnabled(CppRuleClasses.LAYERING_CHECK)) {
      options.add("-Xclang-only=-fmodules-strict-decluse");
    }
  }
  if (FileType.contains(outputFile,CppFileTypes.ASSEMBLER,CppFileTypes.PIC_ASSEMBLER)) {
    options.add("-S");
  }
 else   if (FileType.contains(outputFile,CppFileTypes.PREPROCESSED_C,CppFileTypes.PREPROCESSED_CPP,CppFileTypes.PIC_PREPROCESSED_C,CppFileTypes.PIC_PREPROCESSED_CPP)) {
    options.add("-E");
  }
  if (cppConfiguration.useFission()) {
    options.add("-gsplit-dwarf");
  }
  CcToolchainFeatures.Variables.Builder buildVariables=new CcToolchainFeatures.Variables.Builder();
  if (featureConfiguration.isEnabled(CppRuleClasses.MODULE_MAPS)) {
    buildVariables.addVariable("module_name",cppModuleMap.getName());
    buildVariables.addVariable("module_map_file",cppModuleMap.getArtifact().getExecPathString());
  }
  if (featureConfiguration.isEnabled(CppRuleClasses.USE_HEADER_MODULES)) {
    buildVariables.addSequenceVariable("module_files",getHeaderModulePaths());
  }
  options.addAll(featureConfiguration.getCommandLine(getActionName(),buildVariables.build()));
  return options;
}
