{
  MiddlemanType middlemanType=action.getActionType();
  if (middlemanType.isMiddleman()) {
    if (middlemanType != MiddlemanType.ERROR_PROPAGATING_MIDDLEMAN) {
      checkMiddlemanAction(action,handler,metadataHandler);
    }
    return null;
  }
  Iterable<Artifact> actionInputs=action.getInputs();
  ActionCache.Entry entry=getCacheEntry(action);
  boolean inputsKnown=action.inputsKnown();
  if (entry != null && !entry.isCorrupted() && !inputsKnown) {
    Preconditions.checkState(action.discoversInputs(),action);
    actionInputs=resolveCachedActionInputs(action,entry,resolver);
    if (actionInputs == null) {
      return Token.NEED_TO_RERUN;
    }
  }
  if (mustExecute(action,entry,handler,metadataHandler,actionInputs)) {
    return new Token(getKeyString(action));
  }
  if (!inputsKnown) {
    action.updateInputs(actionInputs);
  }
  return null;
}
