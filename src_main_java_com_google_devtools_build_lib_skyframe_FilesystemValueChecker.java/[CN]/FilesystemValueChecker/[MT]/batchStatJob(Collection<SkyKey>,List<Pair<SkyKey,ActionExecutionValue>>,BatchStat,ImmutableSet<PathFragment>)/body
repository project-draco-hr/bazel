{
  return new Runnable(){
    @Override public void run(){
      Map<Artifact,Pair<SkyKey,ActionExecutionValue>> artifactToKeyAndValue=new HashMap<>();
      for (      Pair<SkyKey,ActionExecutionValue> keyAndValue : shard) {
        ActionExecutionValue actionValue=keyAndValue.getSecond();
        if (actionValue == null) {
          dirtyKeys.add(keyAndValue.getFirst());
        }
 else {
          for (          ArtifactFile file : actionValue.getAllFileValues().keySet()) {
            if (file instanceof Artifact) {
              Artifact artifact=(Artifact)file;
              if (shouldCheckArtifact(knownModifiedOutputFiles,artifact)) {
                artifactToKeyAndValue.put(artifact,keyAndValue);
              }
            }
          }
        }
      }
      List<Artifact> artifacts=ImmutableList.copyOf(artifactToKeyAndValue.keySet());
      List<FileStatusWithDigest> stats;
      try {
        stats=batchStatter.batchStat(true,true,Artifact.asPathFragments(artifacts));
      }
 catch (      IOException e) {
        LoggingUtil.logToRemote(Level.WARNING,"Unable to process batch stat",e);
        outputStatJob(dirtyKeys,shard,knownModifiedOutputFiles).run();
        return;
      }
catch (      InterruptedException e) {
        return;
      }
      Preconditions.checkState(artifacts.size() == stats.size(),"artifacts.size() == %s stats.size() == %s",artifacts.size(),stats.size());
      for (int i=0; i < artifacts.size(); i++) {
        Artifact artifact=artifacts.get(i);
        FileStatusWithDigest stat=stats.get(i);
        Pair<SkyKey,ActionExecutionValue> keyAndValue=artifactToKeyAndValue.get(artifact);
        ActionExecutionValue actionValue=keyAndValue.getSecond();
        SkyKey key=keyAndValue.getFirst();
        FileValue lastKnownData=actionValue.getAllFileValues().get(artifact);
        try {
          FileValue newData=ActionMetadataHandler.fileValueFromArtifactFile(artifact,stat,tsgm);
          if (!newData.equals(lastKnownData)) {
            updateIntraBuildModifiedCounter(stat != null ? stat.getLastChangeTime() : -1,lastKnownData.isSymlink(),newData.isSymlink());
            modifiedOutputFilesCounter.getAndIncrement();
            dirtyKeys.add(key);
          }
        }
 catch (        IOException e) {
          modifiedOutputFilesCounter.getAndIncrement();
          dirtyKeys.add(key);
        }
      }
    }
  }
;
}
