{
  Preconditions.checkState(!serving);
  server=NettyServerBuilder.forAddress(new InetSocketAddress("localhost",port)).addService(commandServer).build();
  server.start();
  if (maxIdleSeconds > 0) {
    Thread timeoutThread=new Thread(new Runnable(){
      @Override public void run(){
        timeoutThread();
      }
    }
);
    timeoutThread.setDaemon(true);
    timeoutThread.start();
  }
  serving=true;
  writeServerFile(PORT_FILE,getAddressString());
  writeServerFile(REQUEST_COOKIE_FILE,requestCookie);
  writeServerFile(RESPONSE_COOKIE_FILE,responseCookie);
  try {
    server.awaitTermination();
  }
 catch (  InterruptedException e) {
    throw new IllegalStateException(e);
  }
}
