{
  ListMultimap<SkyKey,Aspect> result=ArrayListMultimap.create();
  Set<SkyKey> aspectKeys=new HashSet<>();
  for (  Dependency dep : deps) {
    for (    AspectWithParameters depAspect : dep.getAspects()) {
      aspectKeys.add(createAspectKey(dep.getLabel(),dep.getConfiguration(),depAspect));
    }
  }
  Map<SkyKey,ValueOrException3<AspectCreationException,NoSuchThingException,ConfiguredValueCreationException>> depAspects=env.getValuesOrThrow(aspectKeys,AspectCreationException.class,NoSuchThingException.class,ConfiguredValueCreationException.class);
  for (  Dependency dep : deps) {
    SkyKey depKey=TO_KEYS.apply(dep);
    if (result.containsKey(depKey)) {
      continue;
    }
    ConfiguredTarget depConfiguredTarget=configuredTargetMap.get(depKey);
    for (    AspectWithParameters depAspect : dep.getAspects()) {
      if (!aspectMatchesConfiguredTarget(depConfiguredTarget,depAspect.getAspectFactory())) {
        continue;
      }
      SkyKey aspectKey=createAspectKey(dep.getLabel(),dep.getConfiguration(),depAspect);
      AspectValue aspectValue=null;
      try {
        aspectValue=(AspectValue)depAspects.get(aspectKey).get();
      }
 catch (      ConfiguredValueCreationException e) {
        throw new IllegalStateException(e);
      }
catch (      NoSuchThingException e) {
        AspectFactory<?,?,?> depAspectFactory=AspectFactory.Util.create(depAspect.getAspectFactory());
        throw new AspectCreationException(String.format("Evaluation of aspect %s on %s failed: %s",depAspectFactory.getDefinition().getName(),dep.getLabel(),e.toString()));
      }
      if (aspectValue == null) {
        return null;
      }
      result.put(depKey,aspectValue.getAspect());
      transitivePackages.addTransitive(aspectValue.getTransitivePackages());
    }
  }
  return result;
}
