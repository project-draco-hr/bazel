{
  PathFragment ccRelativeName=semantics.getEffectiveSourcePath(sourceArtifact);
  LipoContextProvider lipoProvider=null;
  if (cppConfiguration.isLipoOptimization()) {
    lipoProvider=Preconditions.checkNotNull(CppHelper.getLipoContextProvider(ruleContext),outputName);
    builder.setContext(CppCompilationContext.mergeForLipo(lipoProvider.getLipoContext(),context));
  }
  if (fake) {
    Artifact outputFile=ruleContext.getRelatedArtifact(outputName,outputExtension);
    PathFragment tempOutputName=FileSystemUtils.replaceExtension(outputFile.getExecPath(),".temp" + outputExtension);
    builder.setOutputFile(outputFile).setDotdFile(outputName,dependencyFileExtension).setTempOutputFile(tempOutputName);
    semantics.finalizeCompileActionBuilder(ruleContext,builder);
    CppCompileAction action=builder.build();
    env.registerAction(action);
    if (addObject) {
      result.addObjectFile(action.getOutputFile());
    }
  }
 else {
    boolean generatePicAction=getGeneratePicActions();
    boolean generateNoPicAction=getGenerateNoPicActions();
    Preconditions.checkState(generatePicAction || generateNoPicAction);
    if (generatePicAction) {
      CppCompileActionBuilder picBuilder=copyAsPicBuilder(builder,outputName,outputExtension,dependencyFileExtension);
      cppConfiguration.getFdoSupport().configureCompilation(picBuilder,ruleContext,env,ruleContext.getLabel(),ccRelativeName,nocopts,true,lipoProvider);
      if (maySaveTemps) {
        result.addTemps(createTempsActions(sourceArtifact,outputName,picBuilder,true));
      }
      if (isCodeCoverageEnabled()) {
        picBuilder.setGcnoFile(ruleContext.getRelatedArtifact(outputName,".pic.gcno"));
      }
      semantics.finalizeCompileActionBuilder(ruleContext,picBuilder);
      CppCompileAction picAction=picBuilder.build();
      env.registerAction(picAction);
      if (addObject) {
        result.addPicObjectFile(picAction.getOutputFile());
      }
      if (picAction.getDwoFile() != null) {
        result.addPicDwoFile(picAction.getDwoFile());
      }
      if (cppConfiguration.isLipoContextCollector() && !generateNoPicAction) {
        result.addLipoScannable(picAction);
      }
    }
    if (generateNoPicAction) {
      builder.setOutputFile(ruleContext.getRelatedArtifact(outputName,outputExtension)).setDotdFile(outputName,dependencyFileExtension);
      cppConfiguration.getFdoSupport().configureCompilation(builder,ruleContext,env,ruleContext.getLabel(),ccRelativeName,nocopts,false,lipoProvider);
      if (maySaveTemps) {
        result.addTemps(createTempsActions(sourceArtifact,outputName,builder,false));
      }
      if (!cppConfiguration.isLipoOptimization() && isCodeCoverageEnabled()) {
        builder.setGcnoFile(ruleContext.getRelatedArtifact(outputName,".gcno"));
      }
      semantics.finalizeCompileActionBuilder(ruleContext,builder);
      CppCompileAction compileAction=builder.build();
      env.registerAction(compileAction);
      Artifact objectFile=compileAction.getOutputFile();
      if (addObject) {
        result.addObjectFile(objectFile);
      }
      if (compileAction.getDwoFile() != null) {
        result.addDwoFile(compileAction.getDwoFile());
      }
      if (cppConfiguration.isLipoContextCollector()) {
        result.addLipoScannable(compileAction);
      }
    }
  }
}
