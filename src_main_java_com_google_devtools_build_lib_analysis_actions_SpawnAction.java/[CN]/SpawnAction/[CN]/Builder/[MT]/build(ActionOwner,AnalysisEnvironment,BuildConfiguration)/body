{
  if (isShellCommand && executable == null) {
    executable=configuration.getShExecutable();
  }
  Preconditions.checkNotNull(executable);
  Preconditions.checkNotNull(executableArgs);
  if (useDefaultShellEnvironment) {
    this.environment=configuration.getLocalShellEnvironment();
  }
  ImmutableList<String> argv=ImmutableList.<String>builder().add(executable.getPathString()).addAll(executableArgs).build();
  Iterable<String> arguments=argumentsBuilder.build();
  Artifact paramsFile=ParamFileHelper.getParamsFileMaybe(argv,arguments,commandLine,paramFileInfo,configuration,analysisEnvironment,outputs);
  List<Action> actions=new ArrayList<>();
  CommandLine actualCommandLine;
  if (paramsFile != null) {
    actualCommandLine=ParamFileHelper.createWithParamsFile(argv,arguments,commandLine,isShellCommand,owner,actions,paramFileInfo,paramsFile);
    inputsBuilder.add(paramsFile);
  }
 else {
    actualCommandLine=ParamFileHelper.createWithoutParamsFile(argv,arguments,commandLine,isShellCommand);
  }
  NestedSet<Artifact> tools=toolsBuilder.build();
  NestedSet<Artifact> inputsAndTools=NestedSetBuilder.<Artifact>stableOrder().addTransitive(inputsBuilder.build()).addTransitive(tools).build();
  LinkedHashMap<PathFragment,Artifact> inputAndToolManifests=new LinkedHashMap<>(inputManifests);
  inputAndToolManifests.putAll(toolManifests);
  actions.add(0,new SpawnAction(owner,tools,inputsAndTools,ImmutableList.copyOf(outputs),resourceSet,actualCommandLine,environment,executionInfo,progressMessage,ImmutableMap.copyOf(inputAndToolManifests),mnemonic,executeUnconditionally,extraActionInfoSupplier));
  return actions.toArray(new Action[actions.size()]);
}
