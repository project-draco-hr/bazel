{
  Executor executor=actionExecutionContext.getExecutor();
  if (verboseFailuresAndSubcommandsInEnv) {
    ImmutableMap.Builder<String,String> environmentBuilder=new ImmutableMap.Builder<String,String>().putAll(environment);
    if (executor.getVerboseFailures()) {
      environmentBuilder.put(VERBOSE_FAILURES_KEY,"true");
    }
    if (executor.reportsSubcommands()) {
      environmentBuilder.put(SUBCOMMANDS_KEY,"true");
    }
    this.environment=environmentBuilder.build();
  }
  try {
    internalExecute(actionExecutionContext);
  }
 catch (  ExecException e) {
    String failMessage=progressMessage;
    if (isShellCommand()) {
      failMessage="error executing shell command: " + "'" + truncate(Iterables.get(argv.arguments(),2),200) + "'";
    }
    throw e.toActionExecutionException(failMessage,executor.getVerboseFailures(),this);
  }
}
