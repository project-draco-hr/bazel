{
  List<RuleDefinition> extraRules=getExtraRules();
  if (!extraRules.isEmpty()) {
    ConfiguredRuleClassProvider.Builder builder=new ConfiguredRuleClassProvider.Builder();
    TestRuleClassProvider.addStandardRules(builder);
    for (    RuleDefinition def : extraRules) {
      builder.addRuleDefinition(def);
    }
    ruleClassProvider=builder.build();
  }
 else {
    ruleClassProvider=TestRuleClassProvider.getRuleClassProvider();
  }
  packageFactory=new PackageFactory(ruleClassProvider,getEnvironmentExtensions());
  skyframeExecutor=createSkyframeExecutor(getPreprocessorFactorySupplier());
  setUpSkyframe(parsePackageCacheOptions());
}
