{
  Artifact buildInfo=Iterables.getOnlyElement(ruleContext.getBuildInfo(ObjcBuildInfoFactory.KEY));
  String generatedVersionPlistPath=getGeneratedVersionPlist().getShellEscapedExecPathString();
  String shellCommand="VERSION=\"$(" + "grep \"^" + BuildInfo.BUILD_EMBED_LABEL + "\" "+ buildInfo.getShellEscapedExecPathString()+ " | cut -d' ' -f2- | sed -e '"+ EXTRACT_VERSION_NUMBER_SED_COMMAND+ "' | "+ "sed -e 's#\"#\\\"#g')\" && "+ "cat >"+ generatedVersionPlistPath+ " <<EOF\n"+ "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"+ "<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" "+ "\"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\n"+ "<plist version=\"1.0\">\n"+ "<dict>\n"+ "EOF\n"+ "if [[ -n \"${VERSION}\" ]]; then\n"+ "  for KEY in CFBundleVersion CFBundleShortVersionString; do\n"+ "    echo \"  <key>${KEY}</key>\n\" >> "+ generatedVersionPlistPath+ "\n"+ "    echo \"  <string>${VERSION}</string>\n\" >> "+ generatedVersionPlistPath+ "\n"+ "  done\n"+ "fi\n"+ "cat >>"+ generatedVersionPlistPath+ " <<EOF\n"+ "</dict>\n"+ "</plist>\n"+ "EOF\n";
  ruleContext.registerAction(new SpawnAction.Builder().setMnemonic("ObjcVersionPlist").setShellCommand(shellCommand).addInput(buildInfo).addOutput(getGeneratedVersionPlist()).build(ruleContext));
}
