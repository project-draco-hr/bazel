{
  if (closeCalled.getAndSet(true)) {
    String msg=String.format("For key %s, 'close' can be called at most once per " + "AutoUnlocker instance",key);
    throw new IllegalUnlockException(msg);
  }
  if (!lock.isHeldByCurrentThread()) {
    String msg=String.format("For key %s, the calling thread to 'close' must be the one " + "that acquired the AutoUnlocker",key);
    throw new IllegalUnlockException(msg);
  }
  try {
    Lock waitersLock=waitersLocks.get(key);
    try {
      waitersLock.lock();
      waiters.remove(key);
      if (waiters.count(key) == 0) {
        Preconditions.checkState(locks.remove(key,lock),key);
      }
    }
  finally {
      waitersLock.unlock();
    }
  }
  finally {
    lock.unlock();
  }
}
