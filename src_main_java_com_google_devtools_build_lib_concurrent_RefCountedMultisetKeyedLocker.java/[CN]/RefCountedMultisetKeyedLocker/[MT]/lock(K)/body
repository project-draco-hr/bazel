{
  ReentrantLock newLock=new ReentrantLock();
  newLock.lock();
  Lock waitersLock=waitersLocks.get(key);
  try {
    waitersLock.lock();
    waiters.add(key);
  }
  finally {
    waitersLock.unlock();
  }
  ReentrantLock lock;
  lock=locks.putIfAbsent(key,newLock);
  if (lock != null) {
    Preconditions.checkState(lock != newLock);
    newLock.unlock();
    lock.lock();
    return new RefCountedAutoUnlocker(key,lock);
  }
  return new RefCountedAutoUnlocker(key,newLock);
}
