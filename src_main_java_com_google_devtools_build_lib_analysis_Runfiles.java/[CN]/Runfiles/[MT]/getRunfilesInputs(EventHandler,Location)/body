{
  ConflictChecker checker=new ConflictChecker(conflictPolicy,eventHandler,location);
  Map<PathFragment,Artifact> manifest=getSymlinksAsMap(checker);
  for (  Artifact artifact : getUnconditionalArtifactsWithoutMiddlemen()) {
    checker.put(manifest,artifact.getRootRelativePath(),artifact);
  }
  for (  Runfiles.PruningManifest pruningManifest : getPruningManifests()) {
    Map<String,Artifact> allowedRunfiles=new HashMap<>();
    for (    Artifact artifact : pruningManifest.getCandidateRunfiles()) {
      allowedRunfiles.put(artifact.getRootRelativePath().getPathString(),artifact);
    }
    try (BufferedReader reader=new BufferedReader(new InputStreamReader(pruningManifest.getManifestFile().getPath().getInputStream()))){
      String line;
      while ((line=reader.readLine()) != null) {
        Artifact artifact=allowedRunfiles.get(line);
        if (artifact != null) {
          checker.put(manifest,artifact.getRootRelativePath(),artifact);
        }
      }
    }
   }
  manifest=filterListForObscuringSymlinks(eventHandler,location,manifest);
  for (  PathFragment extraPath : emptyFilesSupplier.getExtraPaths(manifest.keySet())) {
    checker.put(manifest,extraPath,null);
  }
  PathFragment suffixPath=new PathFragment(suffix);
  Map<PathFragment,Artifact> rootManifest=new HashMap<>();
  for (  Map.Entry<PathFragment,Artifact> entry : manifest.entrySet()) {
    checker.put(rootManifest,suffixPath.getRelative(entry.getKey()),entry.getValue());
  }
  if (conflictPolicy == ConflictPolicy.IGNORE) {
    checker=new ConflictChecker(ConflictPolicy.WARN,eventHandler,location);
  }
  for (  Map.Entry<PathFragment,Artifact> entry : getRootSymlinksAsMap(checker).entrySet()) {
    PathFragment mappedPath=entry.getKey();
    Artifact mappedArtifact=entry.getValue();
    checker.put(rootManifest,mappedPath,mappedArtifact);
  }
  return rootManifest;
}
