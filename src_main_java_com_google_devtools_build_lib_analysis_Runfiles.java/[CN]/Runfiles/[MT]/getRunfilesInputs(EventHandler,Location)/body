{
  Map<PathFragment,Artifact> manifest=getSymlinksAsMap();
  for (  Artifact artifact : getUnconditionalArtifactsWithoutMiddlemen()) {
    manifest.put(artifact.getRootRelativePath(),artifact);
  }
  for (  Runfiles.PruningManifest pruningManifest : getPruningManifests()) {
    Map<String,Artifact> allowedRunfiles=new HashMap<>();
    for (    Artifact artifact : pruningManifest.getCandidateRunfiles()) {
      allowedRunfiles.put(artifact.getRootRelativePath().getPathString(),artifact);
    }
    try (BufferedReader reader=new BufferedReader(new InputStreamReader(pruningManifest.getManifestFile().getPath().getInputStream()))){
      String line;
      while ((line=reader.readLine()) != null) {
        Artifact artifact=allowedRunfiles.get(line);
        if (artifact != null) {
          manifest.put(artifact.getRootRelativePath(),artifact);
        }
      }
    }
   }
  manifest=filterListForObscuringSymlinks(eventHandler,location,manifest);
  for (  PathFragment extraPath : emptyFilesSupplier.getExtraPaths(manifest.keySet())) {
    manifest.put(extraPath,null);
  }
  PathFragment path=new PathFragment(suffix);
  Map<PathFragment,Artifact> result=new HashMap<>();
  for (  Map.Entry<PathFragment,Artifact> entry : manifest.entrySet()) {
    result.put(path.getRelative(entry.getKey()),entry.getValue());
  }
  for (  Map.Entry<PathFragment,Artifact> entry : getRootSymlinksAsMap().entrySet()) {
    PathFragment mappedPath=entry.getKey();
    Artifact mappedArtifact=entry.getValue();
    if (result.put(mappedPath,mappedArtifact) != null) {
      if (eventHandler != null) {
        eventHandler.handle(Event.warn(location,"overwrote " + mappedPath + " symlink mapping "+ "with root symlink to "+ mappedArtifact));
      }
    }
  }
  return result;
}
