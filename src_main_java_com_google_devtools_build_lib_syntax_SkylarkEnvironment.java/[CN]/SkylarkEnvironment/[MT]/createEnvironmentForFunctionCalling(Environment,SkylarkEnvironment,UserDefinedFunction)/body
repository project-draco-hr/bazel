{
  if (callerEnv.getStackTrace().contains(function)) {
    throw new EvalException(function.getLocation(),"Recursion was detected when calling '" + function.getName() + "' from '"+ Iterables.getLast(callerEnv.getStackTrace()).getName()+ "'");
  }
  ImmutableList<BaseFunction> stackTrace=new ImmutableList.Builder<BaseFunction>().addAll(callerEnv.getStackTrace()).add(function).build();
  SkylarkEnvironment childEnv=new SkylarkEnvironment(definitionEnv,stackTrace,callerEnv.eventHandler);
  if (callerEnv.isLoadingPhase()) {
    childEnv.setLoadingPhase();
  }
  try {
    for (    String varname : callerEnv.propagatingVariables) {
      childEnv.updateAndPropagate(varname,callerEnv.lookup(varname));
    }
  }
 catch (  NoSuchVariableException e) {
    throw new IllegalStateException(e);
  }
  return childEnv;
}
