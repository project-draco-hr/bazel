{
  if (callerEnv.getStackTrace().contains(function.getName())) {
    throw new EvalException(function.getLocation(),"Recursion was detected when calling '" + function.getName() + "' from '"+ Iterables.getLast(callerEnv.getStackTrace())+ "'");
  }
  ImmutableList<String> stackTrace=new ImmutableList.Builder<String>().addAll(callerEnv.getStackTrace()).add(function.getName()).build();
  SkylarkEnvironment childEnv=new SkylarkEnvironment(definitionEnv,stackTrace,callerEnv.eventHandler);
  try {
    for (    String varname : callerEnv.propagatingVariables) {
      childEnv.updateAndPropagate(varname,callerEnv.lookup(varname));
    }
  }
 catch (  NoSuchVariableException e) {
    throw new IllegalStateException(e);
  }
  childEnv.disabledVariables=callerEnv.disabledVariables;
  childEnv.disabledNameSpaces=callerEnv.disabledNameSpaces;
  return childEnv;
}
