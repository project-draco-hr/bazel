{
  checkAttributes(ruleContext);
  if (ruleContext.hasErrors()) {
    return null;
  }
  J2ObjcSrcsProvider j2ObjcSrcsProvider=new J2ObjcSrcsProvider.Builder().addTransitiveFromDeps(ruleContext).addEntryClasses(ruleContext.attributes().get("entry_classes",Type.STRING_LIST)).build();
  ObjcProvider.Builder objcProviderBuilder=new ObjcProvider.Builder().addTransitiveAndPropagate(ruleContext.getPrerequisite("$jre_emul_lib",Mode.TARGET,ObjcProvider.class)).addTransitiveAndPropagate(ruleContext.getPrerequisites("deps",Mode.TARGET,ObjcProvider.class));
  XcodeProvider.Builder xcodeProviderBuilder=new XcodeProvider.Builder();
  XcodeSupport xcodeSupport=new XcodeSupport(ruleContext).addDependencies(xcodeProviderBuilder,new Attribute("$jre_emul_lib",Mode.TARGET)).addDependencies(xcodeProviderBuilder,new Attribute("deps",Mode.TARGET));
  if (j2ObjcSrcsProvider.hasProtos()) {
    if (ruleContext.attributes().has("$protobuf_lib",Type.LABEL)) {
      objcProviderBuilder.addTransitiveAndPropagate(ruleContext.getPrerequisite("$protobuf_lib",Mode.TARGET,ObjcProvider.class));
      xcodeSupport.addDependencies(xcodeProviderBuilder,new Attribute("$protobuf_lib",Mode.TARGET));
    }
 else {
      throw new IllegalStateException("Found protos in the dependencies of rule " + ruleContext.getLabel() + ", "+ "but protos are not supported in Bazel.");
    }
  }
  for (  J2ObjcSource j2objcSource : j2ObjcSrcsProvider.getSrcs()) {
    PathFragment genDirHeaderSearchPath=new PathFragment(j2objcSource.getObjcFilePath(),ruleContext.getConfiguration().getGenfilesFragment());
    objcProviderBuilder.addAll(ObjcProvider.HEADER,j2objcSource.getObjcHdrs());
    objcProviderBuilder.add(ObjcProvider.INCLUDE,j2objcSource.getObjcFilePath());
    objcProviderBuilder.add(ObjcProvider.INCLUDE,genDirHeaderSearchPath);
    xcodeProviderBuilder.addHeaders(j2objcSource.getObjcHdrs());
    xcodeProviderBuilder.addUserHeaderSearchPaths(ImmutableList.of(j2objcSource.getObjcFilePath(),genDirHeaderSearchPath));
  }
  ObjcProvider objcProvider=objcProviderBuilder.build();
  xcodeSupport.addXcodeSettings(xcodeProviderBuilder,objcProvider,LIBRARY_STATIC);
  return new RuleConfiguredTargetBuilder(ruleContext).setFilesToBuild(NestedSetBuilder.<Artifact>emptySet(STABLE_ORDER)).add(RunfilesProvider.class,RunfilesProvider.EMPTY).addProvider(J2ObjcSrcsProvider.class,j2ObjcSrcsProvider).addProvider(J2ObjcMappingFileProvider.class,ObjcRuleClasses.j2ObjcMappingFileProvider(ruleContext)).addProvider(ObjcProvider.class,objcProvider).addProvider(XcodeProvider.class,xcodeProviderBuilder.build()).build();
}
