{
  HttpURLConnection connection=(HttpURLConnection)url.openConnection(createProxyIfNeeded(url.getProtocol()));
  connection.setInstanceFollowRedirects(true);
  connection.connect();
  if (connection.getResponseCode() != HttpURLConnection.HTTP_OK) {
    InputStream errorStream=connection.getErrorStream();
    throw new IOException(connection.getResponseCode() + ": " + new String(ByteStreams.toByteArray(errorStream),StandardCharsets.UTF_8));
  }
  return new HttpConnection(connection.getInputStream(),parseContentLength(connection));
}
