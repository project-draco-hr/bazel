{
  HttpURLConnection connection=(HttpURLConnection)url.openConnection(createProxyIfNeeded(url.getProtocol()));
  connection.setInstanceFollowRedirects(true);
  connection.connect();
  if (connection.getResponseCode() == HttpURLConnection.HTTP_OK) {
    return connection.getInputStream();
  }
  InputStream errorStream=connection.getErrorStream();
  throw new IOException(connection.getResponseCode() + ": " + new String(ByteStreams.toByteArray(errorStream),StandardCharsets.UTF_8));
}
