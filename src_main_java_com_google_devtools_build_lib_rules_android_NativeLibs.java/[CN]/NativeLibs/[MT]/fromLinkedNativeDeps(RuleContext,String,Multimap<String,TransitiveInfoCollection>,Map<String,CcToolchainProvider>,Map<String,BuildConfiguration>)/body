{
  Map<String,Iterable<Artifact>> result=new LinkedHashMap<>();
  for (  Map.Entry<String,Collection<TransitiveInfoCollection>> entry : depsByArchitecture.asMap().entrySet()) {
    CcLinkParams linkParams=AndroidCommon.getCcLinkParamsStore(entry.getValue()).get(true,true);
    Artifact nativeDepsLibrary=NativeDepsHelper.maybeCreateAndroidNativeDepsAction(ruleContext,linkParams,configurationMap.get(entry.getKey()),toolchainMap.get(entry.getKey()));
    ImmutableList.Builder<Artifact> librariesBuilder=ImmutableList.builder();
    librariesBuilder.addAll(filterUniqueSharedLibraries(ruleContext,linkParams.getLibraries()));
    if (nativeDepsLibrary != null) {
      librariesBuilder.add(nativeDepsLibrary);
    }
    ImmutableList<Artifact> libraries=librariesBuilder.build();
    if (!libraries.isEmpty()) {
      result.put(entry.getKey(),libraries);
    }
  }
  if (result.isEmpty()) {
    return NativeLibs.EMPTY;
  }
 else {
    Artifact anyNativeLibrary=result.entrySet().iterator().next().getValue().iterator().next();
    Artifact nativeDepsName=ruleContext.getUniqueDirectoryArtifact("nativedeps_filename",nativeDepsFileName,ruleContext.getBinOrGenfilesDirectory());
    ruleContext.registerAction(new FileWriteAction(ruleContext.getActionOwner(),nativeDepsName,anyNativeLibrary.getExecPath().getBaseName(),false));
    return new NativeLibs(ImmutableMap.copyOf(result),nativeDepsName);
  }
}
