{
  SkyKey packageKey=PackageValue.key(Label.EXTERNAL_PACKAGE_IDENTIFIER);
  PackageValue packageValue;
  try {
    packageValue=(PackageValue)env.getValueOrThrow(packageKey,NoSuchPackageException.class);
  }
 catch (  NoSuchPackageException e) {
    throw new RepositoryFunctionException(new BuildFileNotFoundException(Label.EXTERNAL_PACKAGE_IDENTIFIER,"Could not load //external package"),Transience.PERSISTENT);
  }
  if (packageValue == null) {
    return null;
  }
  Package externalPackage=packageValue.getPackage();
  if (externalPackage.containsErrors()) {
    throw new RepositoryFunctionException(new BuildFileContainsErrorsException(Label.EXTERNAL_PACKAGE_IDENTIFIER,"Could not load //external package"),Transience.PERSISTENT);
  }
  Rule rule=externalPackage.getRule(repository);
  if (rule == null) {
    throw new RepositoryNotFoundException(repository);
  }
  return rule;
}
