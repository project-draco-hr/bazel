{
  NestedSetBuilder<TaggedEvents> eventBuilder=NestedSetBuilder.stableOrder();
  ImmutableList<Event> events=eventHandler.getEvents();
  if (!events.isEmpty()) {
    eventBuilder.add(new TaggedEvents(getTagFromKey(),events));
  }
  if (storedEventFilter.storeEvents()) {
    Set<SkyKey> depKeys=graph.get(skyKey).getTemporaryDirectDeps();
    Map<SkyKey,ValueWithMetadata> deps=getValuesMaybeFromError(depKeys,bubbleErrorInfo);
    if (!missingChildren && depKeys.size() != deps.size()) {
      throw new IllegalStateException("Missing keys for " + skyKey + ": "+ Sets.difference(depKeys,deps.keySet())+ ", "+ graph.get(skyKey));
    }
    for (    ValueWithMetadata value : deps.values()) {
      eventBuilder.addTransitive(value.getTransitiveEvents());
    }
  }
  return eventBuilder.build();
}
