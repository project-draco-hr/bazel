{
  NestedSetBuilder<TaggedEvents> eventBuilder=NestedSetBuilder.stableOrder();
  ImmutableList<Event> events=eventHandler.getEvents();
  if (!events.isEmpty()) {
    eventBuilder.add(new TaggedEvents(getTagFromKey(),events));
  }
  if (storedEventFilter.storeEvents()) {
    Set<SkyKey> depKeys=graph.get(skyKey).getTemporaryDirectDeps();
    Map<SkyKey,SkyValue> deps=getValuesMaybeFromError(depKeys,bubbleErrorInfo);
    if (!missingChildren && depKeys.size() != deps.size()) {
      throw new IllegalStateException("Missing keys for " + skyKey + ": "+ Sets.difference(depKeys,deps.keySet())+ ", "+ graph.get(skyKey));
    }
    for (    SkyValue value : deps.values()) {
      if (value == NULL_MARKER) {
        Preconditions.checkState(missingChildren,"Missing dep in %s for %s",depKeys,skyKey);
      }
 else {
        eventBuilder.addTransitive(ValueWithMetadata.getEvents(value));
      }
    }
  }
  return eventBuilder.build();
}
