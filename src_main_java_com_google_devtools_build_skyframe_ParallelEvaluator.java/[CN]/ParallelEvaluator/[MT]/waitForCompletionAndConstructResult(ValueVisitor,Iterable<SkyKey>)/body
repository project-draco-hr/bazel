{
  Map<SkyKey,ValueWithMetadata> bubbleErrorInfo=null;
  boolean catastrophe=false;
  try {
    visitor.waitForCompletion();
  }
 catch (  final SchedulerException e) {
    if (!visitor.getCrashes().isEmpty()) {
      reporter.handle(Event.error("Crashes detected: " + visitor.getCrashes()));
      throw Iterables.getFirst(visitor.getCrashes(),null);
    }
    Throwables.propagateIfPossible(e.getCause(),InterruptedException.class);
    if (Thread.interrupted()) {
      throw new InterruptedException();
    }
    SkyKey errorKey=Preconditions.checkNotNull(e.getFailedValue(),e);
    ErrorInfo errorInfo=Preconditions.checkNotNull(e.getErrorInfo(),errorKey);
    if (!keepGoing) {
      bubbleErrorInfo=bubbleErrorUp(errorInfo,errorKey,skyKeys,visitor);
    }
 else {
      Preconditions.checkState(errorInfo.isCatastrophic(),"Scheduler exception only thrown for catastrophe in keep_going evaluation: %s",e);
      catastrophe=true;
      bubbleErrorInfo=ImmutableMap.of(errorKey,ValueWithMetadata.wrapWithMetadata(graph.get(null,Reason.ERROR_BUBBLING,errorKey).getValueMaybeWithMetadata()));
    }
  }
  Preconditions.checkState(visitor.getCrashes().isEmpty(),visitor.getCrashes());
  return constructResult(visitor,skyKeys,bubbleErrorInfo,catastrophe);
}
