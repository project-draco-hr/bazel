{
  Package.LegacyBuilder pkgBuilder=packageFunctionCache.getIfPresent(packageId);
  if (pkgBuilder == null) {
    profiler.startTask(ProfilerTask.CREATE_PACKAGE,packageId.toString());
    try {
      Globber globber=packageFactory.createLegacyGlobber(buildFilePath.getParentDirectory(),packageId,packageLocator);
      Preprocessor.Result preprocessingResult=preprocessCache.getIfPresent(packageId);
      if (preprocessingResult == null) {
        if (showLoadingProgress.get()) {
          env.getListener().handle(Event.progress("Loading package: " + packageId));
        }
        ParserInputSource inputSource;
        if (replacementContents == null) {
          long buildFileSize=Preconditions.checkNotNull(buildFileValue,packageId).getSize();
          try {
            inputSource=ParserInputSource.create(buildFilePath,buildFileSize);
          }
 catch (          IOException e) {
            env.getListener().handle(Event.error(Location.fromFile(buildFilePath),e.getMessage()));
            throw new PackageFunctionException(new BuildFileContainsErrorsException(packageId,e.getMessage()),Transience.TRANSIENT);
          }
          try {
            preprocessingResult=packageFactory.preprocess(packageId,inputSource,globber);
          }
 catch (          IOException e) {
            env.getListener().handle(Event.error(Location.fromFile(buildFilePath),"preprocessing failed: " + e.getMessage()));
            throw new PackageFunctionException(new BuildFileContainsErrorsException(packageId,"preprocessing failed",e),Transience.TRANSIENT);
          }
        }
 else {
          ParserInputSource replacementSource=ParserInputSource.create(replacementContents,buildFilePath.asFragment());
          preprocessingResult=Preprocessor.Result.noPreprocessing(replacementSource);
        }
        preprocessCache.put(packageId,preprocessingResult);
      }
      SkylarkImportResult importResult;
      try {
        importResult=discoverSkylarkImports(buildFilePath,buildFileFragment,packageId,env,preprocessingResult.result,preludeStatements);
      }
 catch (      PackageFunctionException|InterruptedException e) {
        preprocessCache.invalidate(packageId);
        throw e;
      }
      if (importResult == null) {
        return null;
      }
      preprocessCache.invalidate(packageId);
      pkgBuilder=packageFactory.createPackageFromPreprocessingResult(externalPkg,packageId,buildFilePath,preprocessingResult,preprocessingResult.events,preludeStatements,importResult.importMap,importResult.fileDependencies,packageLocator,defaultVisibility,globber);
      numPackagesLoaded.incrementAndGet();
      packageFunctionCache.put(packageId,pkgBuilder);
    }
  finally {
      profiler.completeTask(ProfilerTask.CREATE_PACKAGE);
    }
  }
  return pkgBuilder;
}
