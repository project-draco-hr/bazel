{
  PlatformType platformType=getPlatformType(ruleContext);
  ImmutableListMultimap<BuildConfiguration,ObjcProvider> configurationToNonPropagatedObjcMap=ruleContext.getPrerequisitesByConfiguration("non_propagated_deps",Mode.SPLIT,ObjcProvider.class);
  ImmutableListMultimap<BuildConfiguration,TransitiveInfoCollection> configToDepsCollectionMap=ruleContext.getPrerequisitesByConfiguration("deps",Mode.SPLIT);
  Set<BuildConfiguration> childConfigurations=getChildConfigurations(ruleContext);
  IntermediateArtifacts ruleIntermediateArtifacts=ObjcRuleClasses.intermediateArtifacts(ruleContext);
  NestedSetBuilder<Artifact> binariesToLipo=NestedSetBuilder.<Artifact>stableOrder();
  NestedSetBuilder<Artifact> archivesToLipo=NestedSetBuilder.<Artifact>stableOrder();
  NestedSetBuilder<Artifact> filesToBuild=NestedSetBuilder.<Artifact>stableOrder().add(ruleIntermediateArtifacts.combinedArchitectureBinary());
  for (  BuildConfiguration childConfig : childConfigurations) {
    IntermediateArtifacts intermediateArtifacts=ObjcRuleClasses.intermediateArtifacts(ruleContext,childConfig);
    ObjcCommon common=common(ruleContext,childConfig,intermediateArtifacts,nullToEmptyList(configToDepsCollectionMap.get(childConfig)),nullToEmptyList(configurationToNonPropagatedObjcMap.get(childConfig)));
    ImmutableList.Builder<J2ObjcMappingFileProvider> j2ObjcMappingFileProviders=ImmutableList.builder();
    J2ObjcEntryClassProvider.Builder j2ObjcEntryClassProviderBuilder=new J2ObjcEntryClassProvider.Builder();
    for (    TransitiveInfoCollection dep : configToDepsCollectionMap.get(childConfig)) {
      if (dep.getProvider(J2ObjcMappingFileProvider.class) != null) {
        j2ObjcMappingFileProviders.add(dep.getProvider(J2ObjcMappingFileProvider.class));
      }
      if (dep.getProvider(J2ObjcEntryClassProvider.class) != null) {
        j2ObjcEntryClassProviderBuilder.addTransitive(dep.getProvider(J2ObjcEntryClassProvider.class));
      }
    }
    J2ObjcMappingFileProvider j2ObjcMappingFileProvider=J2ObjcMappingFileProvider.union(j2ObjcMappingFileProviders.build());
    J2ObjcEntryClassProvider j2ObjcEntryClassProvider=j2ObjcEntryClassProviderBuilder.build();
    if (!common.getCompilationArtifacts().get().getArchive().isPresent()) {
      ruleContext.throwWithRuleError(REQUIRES_AT_LEAST_ONE_SOURCE_FILE);
    }
    archivesToLipo.add(common.getCompilationArtifacts().get().getArchive().get());
    binariesToLipo.add(intermediateArtifacts.strippedSingleArchitectureBinary());
    ObjcConfiguration objcConfiguration=childConfig.getFragment(ObjcConfiguration.class);
    if (objcConfiguration.experimentalAutoTopLevelUnionObjCProtos()) {
      ProtoSupport protoSupport=new ProtoSupport(ruleContext,TargetType.LINKING_TARGET).registerActions();
      ObjcCommon protoCommon=protoSupport.getCommon();
      new CompilationSupport(ruleContext,protoSupport.getIntermediateArtifacts(),new CompilationAttributes.Builder().build()).registerCompileAndArchiveActions(protoCommon,protoSupport.getUserHeaderSearchPaths());
    }
    new CompilationSupport(ruleContext,childConfig).registerCompileAndArchiveActions(common).registerLinkActions(common.getObjcProvider(),j2ObjcMappingFileProvider,j2ObjcEntryClassProvider,new ExtraLinkArgs(),ImmutableList.<Artifact>of(),DsymOutputType.APP).validateAttributes();
    ruleContext.assertNoErrors();
  }
  AppleConfiguration appleConfiguration=ruleContext.getFragment(AppleConfiguration.class);
  new LipoSupport(ruleContext).registerCombineArchitecturesAction(binariesToLipo.build(),ruleIntermediateArtifacts.combinedArchitectureBinary(),appleConfiguration.getMultiArchPlatform(platformType)).registerCombineArchitecturesAction(archivesToLipo.build(),ruleContext.getImplicitOutputArtifact(AppleBinaryRule.LIPO_ARCHIVE),appleConfiguration.getMultiArchPlatform(platformType));
  RuleConfiguredTargetBuilder targetBuilder=ObjcRuleClasses.ruleConfiguredTarget(ruleContext,filesToBuild.build());
  return targetBuilder.build();
}
