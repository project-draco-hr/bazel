{
  Build.Package.Builder builder=Build.Package.newBuilder();
  builder.setName(pkg.getName());
  builder.setRepository(pkg.getPackageIdentifier().getRepository().toString());
  builder.setBuildFilePath(pkg.getFilename().getPathString());
  builder.setDefaultVisibilitySet(pkg.isDefaultVisibilitySet());
  if (pkg.isDefaultVisibilitySet()) {
    for (    Label visibilityLabel : pkg.getDefaultVisibility().getDeclaredLabels()) {
      builder.addDefaultVisibilityLabel(visibilityLabel.toString());
    }
  }
  builder.setDefaultTestonly(pkg.getDefaultTestOnly());
  if (pkg.getDefaultDeprecation() != null) {
    builder.setDefaultDeprecation(pkg.getDefaultDeprecation());
  }
  for (  String defaultCopt : pkg.getDefaultCopts()) {
    builder.addDefaultCopt(defaultCopt);
  }
  if (pkg.isDefaultHdrsCheckSet()) {
    builder.setDefaultHdrsCheck(pkg.getDefaultHdrsCheck());
  }
  builder.setDefaultLicense(serializeLicense(pkg.getDefaultLicense()));
  for (  DistributionType distributionType : pkg.getDefaultDistribs()) {
    builder.addDefaultDistrib(distributionType.toString());
  }
  for (  String feature : pkg.getFeatures()) {
    builder.addDefaultSetting(feature);
  }
  for (  Label subincludeLabel : pkg.getSubincludeLabels()) {
    builder.addSubincludeLabel(subincludeLabel.toString());
  }
  for (  Label skylarkLabel : pkg.getSkylarkFileDependencies()) {
    builder.addSkylarkLabel(skylarkLabel.toString());
  }
  for (  Build.MakeVar makeVar : serializeMakeEnvironment(pkg.getMakeEnvironment())) {
    builder.addMakeVariable(makeVar);
  }
  for (  Event event : pkg.getEvents()) {
    builder.addEvent(serializeEvent(event));
  }
  builder.setContainsErrors(pkg.containsErrors());
  builder.setContainsTemporaryErrors(pkg.containsTemporaryErrors());
  builder.build().writeDelimitedTo(out);
  emitTargets(pkg.getTargets(),out);
}
