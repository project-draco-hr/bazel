{
  Label ruleLabel=rule.getLabel();
  ImmutableSet<String> mappedAttributes=ImmutableSet.copyOf(attributeMap.getAttributeNames());
  for (  Attribute attribute : attributes) {
    if (!attribute.isImplicit() || !attribute.getCondition().apply(attributeMap)) {
      continue;
    }
    if (attribute.getType() == BuildType.LABEL) {
      Label label=mappedAttributes.contains(attribute.getName()) ? attributeMap.get(attribute.getName(),BuildType.LABEL) : BuildType.LABEL.cast(attribute.getDefaultValue(rule));
      if (label != null) {
        builder.put(attribute,LabelAndConfiguration.of(label,configuration));
      }
    }
 else     if (attribute.getType() == BuildType.LABEL_LIST) {
      List<Label> labelList;
      if (mappedAttributes.contains(attribute.getName())) {
        labelList=new ArrayList<>();
        for (        Label label : attributeMap.get(attribute.getName(),BuildType.LABEL_LIST)) {
          if (attribute.getName().equals("$config_dependencies")) {
            label=ruleLabel.resolveRepositoryRelative(label);
          }
          labelList.add(label);
        }
      }
 else {
        labelList=BuildType.LABEL_LIST.cast(attribute.getDefaultValue(rule));
      }
      for (      Label label : labelList) {
        builder.put(attribute,LabelAndConfiguration.of(label,configuration));
      }
    }
  }
}
